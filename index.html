<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="description" content="Rank Christmas Stories images using Elo ratings">
    <meta name="theme-color" content="#1a1a2e" id="themeColor">
    <meta name="color-scheme" content="dark light">
    <!-- Security: CSP to prevent XSS (worker-src for service worker) -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; img-src 'self' data: blob:; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline' https://www.gstatic.com https://cdn.jsdelivr.net; connect-src 'self' https://*.googleapis.com https://*.firebaseio.com https://*.firebaseapp.com https://*.cloudfunctions.net https://*.a.run.app; worker-src 'self'; frame-ancestors 'none'; base-uri 'self'; form-action 'self'; object-src 'none'; upgrade-insecure-requests;">
    <meta name="referrer" content="strict-origin-when-cross-origin">
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    <!-- iOS Safari -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Christmas Stories</title>
    <!-- Open Graph meta tags for social sharing -->
    <meta property="og:title" content="Christmas Stories">
    <meta property="og:description" content="Rank holiday imagery with Elo ratings. Vote on AI-generated scenes and see how your taste compares to the crowd.">
    <meta property="og:image" content="https://lean-wintermute.github.io/nutcracker/images/teddy_melancholy_01_alone_in_house_01_window_watching_082316.png">
    <meta property="og:image:width" content="1408">
    <meta property="og:image:height" content="768">
    <meta property="og:url" content="https://lean-wintermute.github.io/nutcracker/">
    <meta property="og:type" content="website">
    <meta name="twitter:card" content="summary_large_image">
    <!-- Inline script to prevent FOUC (Flash of Unstyled Content) -->
    <script>
        (function() {
            const stored = localStorage.getItem('nutcracker_theme');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            const theme = stored || (prefersDark ? 'dark' : 'light');
            document.documentElement.setAttribute('data-theme', theme);
        })();
    </script>
    <style>
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

        /* Dark mode (default) - WCAG AA contrast ratios verified */
        :root {
            --color-bg: #1a1a2e;
            --color-bg-alt: #16213e;
            --color-text: #e0e0e0;           /* 10.5:1 on #1a1a2e - WCAG AAA */
            --color-text-muted: #a0a0a0;     /* 6.3:1 on #1a1a2e - WCAG AA */
            --color-text-dim: #9a9a9a;       /* 5.7:1 on #1a1a2e - WCAG AA */
            --color-accent: #f5576c;         /* 5.2:1 on #1a1a2e - WCAG AA */
            --color-accent-alt: #f093fb;     /* 7.4:1 on #1a1a2e - WCAG AA */
            --color-surface: rgba(255,255,255,0.05);
            --color-border: rgba(255,255,255,0.1);
            --color-focus-ring: rgba(245, 87, 108, 0.5);
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --touch-target: 44px;
            --safe-top: env(safe-area-inset-top, 0px);
            --safe-bottom: env(safe-area-inset-bottom, 0px);
        }

        /* Light mode - WCAG AA contrast ratios verified */
        [data-theme="light"] {
            --color-bg: #f5f5f7;
            --color-bg-alt: #e8e8ec;
            --color-text: #1d1d1f;
            --color-text-muted: #515154;  /* 4.6:1 contrast on #f5f5f7 - WCAG AA */
            --color-text-dim: #6e6e73;    /* 4.5:1 contrast on #f5f5f7 - WCAG AA */
            --color-accent: #d63b4f;      /* Darker accent for light mode - 4.6:1 on white */
            --color-accent-alt: #c055d0;  /* Adjusted for light mode contrast */
            --color-surface: rgba(0,0,0,0.03);
            --color-border: rgba(0,0,0,0.12);
            --color-focus-ring: rgba(214, 59, 79, 0.4);
        }

        /* System preference fallback (when no explicit theme set) */
        @media (prefers-color-scheme: light) {
            :root:not([data-theme]) {
                --color-bg: #f5f5f7;
                --color-bg-alt: #e8e8ec;
                --color-text: #1d1d1f;
                --color-text-muted: #515154;
                --color-text-dim: #6e6e73;
                --color-accent: #d63b4f;
                --color-accent-alt: #c055d0;
                --color-surface: rgba(0,0,0,0.03);
                --color-border: rgba(0,0,0,0.12);
                --color-focus-ring: rgba(214, 59, 79, 0.4);
            }
        }

        /* Reduced motion */
        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, var(--color-bg) 0%, var(--color-bg-alt) 100%);
            min-height: 100vh;
            min-height: 100dvh; /* Dynamic viewport for mobile */
            color: var(--color-text);
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            padding-top: var(--safe-top);
            padding-bottom: var(--safe-bottom);
            overscroll-behavior-y: contain;
        }

        /* Skip link for accessibility */
        .skip-link {
            position: absolute;
            top: -100px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--color-accent);
            color: white;
            padding: 12px 24px;
            border-radius: var(--radius-sm);
            z-index: 1000;
            text-decoration: none;
            font-weight: 600;
        }

        .skip-link:focus {
            top: 10px;
            outline: 3px solid white;
            outline-offset: 2px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            padding-left: max(20px, env(safe-area-inset-left));
            padding-right: max(20px, env(safe-area-inset-right));
        }

        /* Large screens - wider container for bigger cards */
        @media (min-width: 1440px) {
            .container {
                max-width: 1400px;
            }
            .card {
                max-width: 680px;
            }
        }

        header {
            text-align: center;
            padding: 20px 0;
            position: relative;
        }

        /* Production branding - top left */
        .production-brand {
            position: absolute;
            top: 20px;
            left: 0;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            font-weight: 500;
            letter-spacing: 0.02em;
            text-decoration: none;
            white-space: nowrap;
        }

        .brand-faded {
            color: rgba(240, 147, 251, 0.5);
        }

        .brand-shimmer {
            display: inline;
            background: linear-gradient(
                90deg,
                var(--color-accent-alt) 0%,
                var(--color-accent-alt) 40%,
                #ffd700 48%,
                #ffd700 52%,
                var(--color-accent-alt) 60%,
                var(--color-accent-alt) 100%
            );
            background-size: 300% 100%;
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            animation: shimmer-sweep 3s ease-in-out infinite alternate;
            -webkit-box-decoration-break: clone;
            box-decoration-break: clone;
        }

        .elmo-icon {
            width: 18px;
            height: 18px;
            flex-shrink: 0;
            border: 1px solid rgba(255,255,255,0.4);
            border-radius: 50%;
            padding: 1px;
        }

        @keyframes shimmer-sweep {
            0% { background-position: 100% 0; }
            100% { background-position: 0% 0; }
        }

        @media (max-width: 480px) {
            .production-brand {
                /* Proportional sizing: scales from 7px at 320px to 10px at 480px */
                font-size: clamp(7px, 2vw, 10px);
                top: 6px;
                left: 4px;
                gap: 4px;
            }
            .elmo-icon {
                width: clamp(10px, 3vw, 14px);
                height: clamp(10px, 3vw, 14px);
            }
        }

        /* Very small screens: hide completely or show minimal version */
        @media (max-width: 350px) {
            .production-brand {
                font-size: 6px;
                gap: 3px;
            }
            .elmo-icon {
                width: 9px;
                height: 9px;
            }
        }

        @media (prefers-reduced-motion: reduce) {
            .brand-shimmer {
                animation: none;
                background: var(--color-accent-alt);
                -webkit-background-clip: text;
                background-clip: text;
            }
        }

        /* Theme toggle button */
        .theme-toggle {
            position: fixed;
            /* Position above privacy-block (8px + ~20px text + 16px gap = 44px min) */
            bottom: calc(44px + env(safe-area-inset-bottom, 0px));
            left: max(12px, env(safe-area-inset-left, 0px));
            /* 44px minimum touch target per WCAG/Apple HIG */
            width: 44px;
            height: 44px;
            border: 1px solid var(--color-border);
            border-radius: 50%;
            background: var(--color-surface);
            color: var(--color-text-muted);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: border-color 0.2s, background-color 0.2s, transform 0.2s;
            -webkit-tap-highlight-color: transparent;
            z-index: 100;
            opacity: 0.7;
        }

        .theme-toggle:hover {
            border-color: var(--color-accent);
            transform: scale(1.05);
            opacity: 1;
        }

        .theme-toggle:focus-visible {
            outline: 3px solid var(--color-accent);
            outline-offset: 2px;
        }

        .theme-toggle:active {
            transform: scale(0.95);
        }

        /* Sun icon (shown in dark mode) */
        .theme-toggle .icon-sun {
            display: block;
        }

        .theme-toggle .icon-moon {
            display: none;
        }

        /* Moon icon (shown in light mode) */
        [data-theme="light"] .theme-toggle .icon-sun {
            display: none;
        }

        [data-theme="light"] .theme-toggle .icon-moon {
            display: block;
        }

        @media (prefers-color-scheme: light) {
            :root:not([data-theme]) .theme-toggle .icon-sun {
                display: none;
            }
            :root:not([data-theme]) .theme-toggle .icon-moon {
                display: block;
            }
        }

        /* Mobile theme toggle - ensure clearance from privacy-block */
        @media (max-width: 480px) {
            .theme-toggle {
                /* On small screens, privacy-block is at 4px + safe-area, so position toggle higher */
                bottom: calc(50px + env(safe-area-inset-bottom, 0px));
                left: max(8px, env(safe-area-inset-left, 0px));
            }
        }

        /* iOS Firefox: larger safe-area buffer (Firefox uses WebKit but handles insets differently) */
        @supports (padding: max(0px)) {
            @media (max-width: 480px) {
                .theme-toggle {
                    /* Extra 8px buffer for iOS Firefox safe area variance */
                    bottom: calc(50px + max(8px, env(safe-area-inset-bottom, 0px)));
                }
            }
        }

        h1 {
            font-size: clamp(1.5rem, 4vw, 1.8rem);
            background: linear-gradient(90deg, var(--color-accent-alt), var(--color-accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stats {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin: 15px 0;
            font-size: 0.9rem;
            color: var(--color-text-muted);
        }

        .stats strong {
            color: var(--color-text);
        }

        /* Live region for screen reader announcements */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        .arena {
            display: flex;
            gap: 20px;
            justify-content: center;
            align-items: stretch;
            flex-wrap: wrap;
            margin: 30px 0;
        }

        .card {
            flex: 1;
            max-width: clamp(500px, 42vw, 650px);
            min-width: 280px;
            background: var(--color-surface);
            border-radius: var(--radius-lg);
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.2s ease, border-color 0.2s ease, box-shadow 0.2s ease;
            border: 2px solid transparent;
            /* iOS tap highlight */
            -webkit-tap-highlight-color: transparent;
            /* Touch action for better scrolling */
            touch-action: manipulation;
            /* Ensure focusable */
            outline: none;
        }

        .card:hover, .card:focus-visible {
            transform: translateY(-5px);
            border-color: var(--color-accent);
            box-shadow: 0 20px 40px rgba(245, 87, 108, 0.2);
        }

        .card:focus-visible {
            outline: 3px solid var(--color-accent);
            outline-offset: 2px;
        }

        .card:active {
            transform: scale(0.98);
        }

        .card img {
            width: 100%;
            height: auto;
            max-height: 45vh;
            aspect-ratio: 1408 / 768;
            object-fit: cover;
            display: block;
            background: var(--color-bg-alt);
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }

        .card-info {
            padding: 15px;
            text-align: center;
            min-height: var(--touch-target);
        }

        .card-title {
            font-size: 0.85rem;
            color: var(--color-text-muted);
            word-break: break-word;
            /* Ensure minimum contrast */
        }

        .card-elo {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--color-accent);
            margin-top: 5px;
        }

        .vs {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--color-text-dim);
            padding: 0 10px;
            min-width: 50px;
        }

        .instructions {
            text-align: center;
            color: var(--color-text-dim);
            margin: 20px 0;
            font-size: 0.9rem;
        }

        .tabs {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 30px 0 20px;
            /* Tab list role */
        }

        .tab {
            padding: 12px 28px;
            background: var(--color-surface);
            border: 2px solid transparent;
            border-radius: 25px;
            color: var(--color-text-muted);
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 1rem;
            font-weight: 500;
            min-height: var(--touch-target);
            -webkit-tap-highlight-color: transparent;
        }

        .tab:hover, .tab:focus-visible {
            border-color: var(--color-accent);
            color: var(--color-text);
        }

        .tab:focus-visible {
            outline: 3px solid var(--color-accent);
            outline-offset: 2px;
        }

        .tab[aria-selected="true"], .tab.active {
            background: linear-gradient(90deg, var(--color-accent-alt), var(--color-accent));
            color: white;
            border-color: transparent;
        }

        .leaderboard {
            display: none;
            max-width: 900px;
            margin: 0 auto;
        }

        .leaderboard.active { display: block; }
        .arena-view.hidden { display: none; }

        /* New gallery-style rankings */
        .rankings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 20px;
            padding: 10px 0;
        }

        /* Larger images on desktop - max 90% page width, fewer columns */
        @media (min-width: 1024px) {
            .rankings-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 24px;
                max-width: 90%;
                margin: 0 auto;
            }
        }

        @media (min-width: 1800px) {
            .rankings-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 28px;
            }
        }

        @media (min-width: 2400px) {
            .rankings-grid {
                grid-template-columns: repeat(4, 1fr);
                gap: 32px;
            }
        }

        @media (max-width: 640px) {
            .rankings-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 6px;
            }
            .rank-badge {
                top: 3%;
                left: 3%;
                font-size: clamp(0.4rem, 2.5vw, 0.6rem);
                padding: 1px 3px;
                min-width: 14px;
                border-radius: 5px;
            }
        }

        @media (max-width: 400px) {
            .rankings-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 4px;
            }
            .rank-card-footer {
                padding: 4px 6px;
                gap: 4px;
            }
            .rank-card-title {
                font-size: 0.7rem;
            }
            .rank-card-elo {
                font-size: 0.65rem;
            }
            .rank-card-stats {
                font-size: 0.5rem;
            }
            .rank-badge {
                top: 2%;
                left: 2%;
                font-size: clamp(0.35rem, 2.8vw, 0.5rem);
                padding: 1px 2px;
                min-width: 12px;
                border-radius: 4px;
            }
        }

        .rank-card {
            position: relative;
            border-radius: var(--radius-md);
            overflow: hidden;
            background: var(--color-surface);
            transition: transform 0.2s ease;
        }

        .rank-card-link {
            display: block;
            width: 100%;
            padding: 0;
            margin: 0;
            border: none;
            background: none;
            cursor: pointer;
            text-decoration: none;
            color: inherit;
        }

        .rank-card-link img {
            width: 100%;
            height: auto;
            aspect-ratio: 1408 / 768;
            object-fit: cover;
            display: block;
            background: var(--color-bg-alt);
            transition: transform 0.2s ease;
        }

        .rank-card:hover .rank-card-link img {
            transform: scale(1.02);
        }

        .rank-badge {
            position: absolute;
            top: 4%;
            left: 4%;
            background: rgba(0,0,0,0.7);
            backdrop-filter: blur(8px);
            color: white;
            font-weight: bold;
            font-size: clamp(0.6rem, 1.5vw, 1rem);
            padding: clamp(2px, 0.4vw, 6px) clamp(4px, 0.8vw, 12px);
            border-radius: clamp(6px, 1vw, 12px);
            min-width: clamp(18px, 3vw, 40px);
            text-align: center;
        }

        .rank-badge.gold { background: linear-gradient(135deg, #f5af19, #f12711); }
        .rank-badge.silver { background: linear-gradient(135deg, #bdc3c7, #7f8c8d); }
        .rank-badge.bronze { background: linear-gradient(135deg, #cd7f32, #8b4513); }

        /* Glow for top 3 cards */
        .rank-card.top-gold { box-shadow: 0 0 24px rgba(245, 175, 25, 0.6), 0 0 8px rgba(245, 175, 25, 0.3); }
        .rank-card.top-silver { box-shadow: 0 0 20px rgba(189, 195, 199, 0.6), 0 0 6px rgba(189, 195, 199, 0.3); }
        .rank-card.top-bronze { box-shadow: 0 0 16px rgba(205, 127, 50, 0.6), 0 0 6px rgba(205, 127, 50, 0.3); }

        /* Share action button on rank cards */
        .rank-action--share {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(8px);
            border: none;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.2s, background 0.2s;
            z-index: 10;
        }

        .rank-card:hover .rank-action--share,
        .rank-card:focus-within .rank-action--share {
            opacity: 1;
        }

        .rank-action--share:hover {
            background: var(--color-accent);
        }

        /* Share menu dialog */
        .share-menu {
            max-width: 360px;
            width: 90vw;
            border-radius: var(--radius-lg);
            border: 1px solid var(--color-border);
            background: var(--color-bg);
            padding: 0;
            box-shadow: 0 20px 40px rgba(0,0,0,0.4);
        }

        .share-menu::backdrop {
            background: rgba(0, 0, 0, 0.7);
        }

        .share-menu-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            border-bottom: 1px solid var(--color-border);
        }

        .share-menu-header h3 {
            margin: 0;
            font-size: 1.1rem;
        }

        .share-menu-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--color-text-muted);
            cursor: pointer;
            padding: 0;
            line-height: 1;
        }

        .share-menu-preview {
            padding: 16px;
            text-align: center;
            border-bottom: 1px solid var(--color-border);
        }

        .share-menu-preview img {
            max-width: 180px;
            border-radius: var(--radius-sm);
            margin-bottom: 8px;
        }

        .share-menu-preview-text {
            color: var(--color-text);
            font-weight: 500;
        }

        .share-options {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            padding: 16px;
        }

        .share-option {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            padding: 12px 8px;
            border: 1px solid var(--color-border);
            border-radius: var(--radius-sm);
            background: var(--color-surface);
            color: var(--color-text);
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.75rem;
        }

        .share-option:hover {
            border-color: var(--color-accent);
            background: rgba(245, 87, 108, 0.1);
        }

        .share-option svg {
            width: 24px;
            height: 24px;
        }

        @media (max-width: 480px) {
            .share-options {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .rank-card-footer {
            padding: 6px 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 8px;
        }

        .rank-card-title {
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--color-text);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            flex: 1;
            min-width: 0;
        }

        .rank-card-meta {
            display: flex;
            align-items: center;
            gap: 6px;
            flex-shrink: 0;
        }

        .rank-card-elo {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--color-accent);
        }

        .rank-card-stats {
            font-size: 0.65rem;
            color: var(--color-text-dim);
        }

        /* Rankings header with toggle */
        .rankings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 0 16px;
            margin-bottom: 8px;
            border-bottom: 1px solid var(--color-border);
        }

        .rankings-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--color-text);
        }

        .rankings-toggle {
            display: flex;
            background: var(--color-surface);
            border-radius: 20px;
            padding: 3px;
            border: 1px solid var(--color-border);
        }

        .rankings-toggle-btn {
            padding: 8px 16px;
            border: none;
            background: transparent;
            color: var(--color-text-muted);
            font-size: 0.8rem;
            font-weight: 500;
            cursor: pointer;
            border-radius: 16px;
            transition: all 0.2s ease;
            min-height: var(--touch-target);
            font-family: inherit;
        }

        .rankings-toggle-btn:hover {
            color: var(--color-text);
        }

        .rankings-toggle-btn.active {
            background: var(--color-accent);
            color: white;
        }

        .rankings-toggle-btn:focus-visible {
            outline: 2px solid var(--color-accent);
            outline-offset: 2px;
        }

        .rankings-header-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .share-btn {
            width: 40px;
            height: 40px;
            border: 1px solid var(--color-border);
            border-radius: 50%;
            background: var(--color-surface);
            color: var(--color-text-muted);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .share-btn:hover {
            border-color: var(--color-accent);
            color: var(--color-accent);
        }

        .share-btn:focus-visible {
            outline: 2px solid var(--color-accent);
            outline-offset: 2px;
        }

        .share-btn:active {
            transform: scale(0.95);
        }

        /* Alignment summary at top of personal rankings */
        .alignment-summary {
            text-align: center;
            padding: 12px 16px;
            margin-bottom: 16px;
            background: var(--color-surface);
            border-radius: var(--radius-sm);
            border: 1px solid var(--color-border);
        }

        .alignment-score {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--color-accent);
        }

        .alignment-detail {
            font-size: 0.85rem;
            color: var(--color-text-muted);
            margin-left: 8px;
        }

        /* Comparison badge on rank cards */
        .rank-comparison {
            position: absolute;
            bottom: 44px;
            right: 8px;
            font-size: 0.65rem;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
            padding: 3px 8px;
            border-radius: 10px;
            color: var(--color-text-muted);
        }
        .rank-comparison.higher {
            color: #4ade80;
            background: rgba(34, 197, 94, 0.2);
        }
        .rank-comparison.lower {
            color: #f87171;
            background: rgba(239, 68, 68, 0.2);
        }
        .rank-comparison.same {
            color: #60a5fa;
            background: rgba(59, 130, 246, 0.2);
        }

        @media (max-width: 480px) {
            .alignment-summary {
                padding: 10px 12px;
            }
            .alignment-score {
                font-size: 1rem;
            }
            .alignment-detail {
                display: block;
                margin-left: 0;
                margin-top: 4px;
            }
            .rank-comparison {
                font-size: 0.6rem;
                bottom: 40px;
            }
        }

        .global-loading {
            text-align: center;
            padding: 40px 20px;
            color: var(--color-text-muted);
        }

        .global-loading svg {
            animation: spin 1s linear infinite;
            margin-bottom: 12px;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .global-stats {
            text-align: center;
            padding: 8px 16px;
            margin-bottom: 16px;
            background: var(--color-surface);
            border-radius: var(--radius-sm);
            font-size: 0.85rem;
            color: var(--color-text-muted);
        }

        .global-stats strong {
            color: var(--color-text);
        }

        /* Site footer with inline suggestion */
        .site-footer {
            margin-top: 30px;
            padding: 20px 0;
            padding-bottom: calc(20px + env(safe-area-inset-bottom, 0px));
        }

        /* Lightbox for image viewing */
        .lightbox {
            position: fixed;
            inset: 0;
            width: 100%;
            height: 100%;
            max-width: 100%;
            max-height: 100%;
            background: rgba(0, 0, 0, 0.95);
            border: none;
            padding: 0;
            margin: 0;
            z-index: 2000;
        }

        .lightbox::backdrop {
            background: rgba(0, 0, 0, 0.95);
        }

        .lightbox[open] {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .lightbox-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 16px;
            width: 100%;
            max-width: min(90vw, 1200px);
            max-height: 100vh;
            padding: 16px;
            box-sizing: border-box;
        }

        .lightbox-content img {
            width: 100%;
            max-height: calc(100vh - 120px);
            aspect-ratio: 1408 / 768;
            object-fit: contain;
            border-radius: var(--radius-md);
            cursor: zoom-in;
            transition: transform 0.3s ease;
            transform-origin: center center;
        }

        .lightbox-content img.zoomed {
            cursor: zoom-out;
            transform: scale(2);
        }

        .lightbox-content img.zoomed.panning {
            cursor: grab;
            transition: none;
        }

        .lightbox-actions {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            width: 100%;
            max-width: 100%;
        }

        @media (max-width: 480px) {
            .lightbox-content {
                padding: 12px;
                gap: 12px;
            }
            .lightbox-content img {
                max-height: calc(100vh - 140px);
                border-radius: var(--radius-sm);
            }
            .lightbox-btn {
                padding: 10px 16px;
                font-size: 0.85rem;
                min-height: 44px;
            }
        }

        .lightbox-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 24px;
            background: rgba(30, 30, 50, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 24px;
            color: #fff;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            text-decoration: none;
            transition: all 0.2s;
            min-height: 48px;
            backdrop-filter: blur(8px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        [data-theme="light"] .lightbox-btn {
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid rgba(0, 0, 0, 0.2);
            color: #1d1d1f;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .lightbox-btn:hover {
            background: var(--color-accent);
            border-color: var(--color-accent);
            color: #fff;
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.4);
        }

        .lightbox-btn--close:hover {
            background: rgba(180, 60, 60, 0.95);
            border-color: rgba(180, 60, 60, 0.95);
        }

        .lightbox-btn.success {
            background: rgba(46, 204, 113, 0.95);
            border-color: rgba(46, 204, 113, 0.95);
            color: #fff;
        }

        .footer-actions {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin-bottom: 20px;
        }

        .btn--small {
            padding: 10px 20px;
            font-size: 0.85rem;
            min-height: 44px;
        }

        .link-btn {
            background: none;
            border: none;
            color: var(--color-accent);
            cursor: pointer;
            text-decoration: underline;
            font-size: inherit;
            padding: 8px 4px;
            min-height: 44px;
            display: inline-flex;
            align-items: center;
        }

        .link-btn:hover {
            color: var(--color-accent-alt);
        }

        .data-notice {
            text-align: center;
            font-size: 0.8rem;
            color: var(--color-text-dim);
            background: var(--color-surface);
            border-radius: var(--radius-md);
            padding: 16px 20px;
            max-width: 500px;
            margin: 0 auto;
        }

        .data-notice p {
            margin: 0 0 8px 0;
        }

        .data-notice p:last-child {
            margin-bottom: 0;
        }

        .data-notice code {
            background: rgba(0,0,0,0.3);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'SF Mono', Monaco, 'Consolas', monospace;
            font-size: 0.75rem;
            color: var(--color-text-muted);
        }

        /* Light mode code blocks need different background */
        [data-theme="light"] .data-notice code {
            background: rgba(0,0,0,0.08);
        }

        @media (prefers-color-scheme: light) {
            :root:not([data-theme]) .data-notice code {
                background: rgba(0,0,0,0.08);
            }
        }

        .actions {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 15px;
            margin: 30px 0;
            padding-bottom: 20px;
        }

        .btn {
            padding: 12px 24px;
            border: 2px solid var(--color-border);
            background: transparent;
            color: var(--color-text-muted);
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.2s ease;
            min-height: var(--touch-target);
            -webkit-tap-highlight-color: transparent;
        }

        .btn:hover, .btn:focus-visible {
            border-color: var(--color-accent);
            color: var(--color-accent);
        }

        .btn:focus-visible {
            outline: 3px solid var(--color-accent);
            outline-offset: 2px;
        }

        .btn--danger:hover, .btn--danger:focus-visible {
            border-color: #ff6b6b;
            color: #ff6b6b;
        }

        .skip-hint {
            text-align: center;
            color: var(--color-text-dim);
            font-size: 0.8rem;
            margin-top: 15px;
        }

        .skip-hint kbd {
            background: var(--color-surface);
            padding: 2px 8px;
            border-radius: 4px;
            font-family: inherit;
            border: 1px solid var(--color-border);
        }

        /* Mobile responsive */
        @media (max-width: 700px) {
            .arena {
                flex-direction: column;
                align-items: center;
                gap: 12px;
                margin: 15px 0;
            }
            .vs {
                padding: 8px 0;
                font-size: 1rem;
            }
            .card {
                max-width: 100%;
                width: 100%;
            }
            .card img {
                max-height: 35vh;
            }
            .card-info {
                padding: 8px 12px;
            }
            .card-title {
                font-size: 0.85rem;
            }
            .tabs {
                gap: 8px;
            }
            .tab {
                padding: 10px 20px;
                font-size: 0.9rem;
            }
        }

        @media (max-width: 480px) {
            .container {
                padding: 12px;
            }
            .arena {
                gap: 8px;
                margin: 10px 0;
            }
            .vs {
                padding: 6px 0;
                font-size: 0.9rem;
            }
            .card img {
                max-height: 30vh;
            }
            .card-info {
                padding: 6px 10px;
            }
            .card-title {
                font-size: 0.8rem;
            }
            .card-elo {
                font-size: 0.75rem;
            }
            .tab {
                padding: 10px 16px;
                font-size: 0.85rem;
            }
            .feedback-tags {
                gap: 6px;
            }
            .feedback-tag {
                padding: 10px 14px;
                font-size: 0.8rem;
            }
        }

        /* Small phones */
        @media (max-width: 380px) {
            .card img {
                max-height: 35vh;
            }
            .stats {
                gap: 15px;
                font-size: 0.85rem;
            }
        }

        @media (max-height: 500px) and (orientation: landscape) {
            .arena {
                flex-direction: row;
                gap: 10px;
            }
            .card img {
                max-height: 40vh;
            }
            .vs {
                padding: 0 5px;
                font-size: 1rem;
            }
            header {
                padding: 10px 0;
            }
            .stats {
                margin: 8px 0;
            }
        }

        @media (hover: none) and (pointer: coarse) {
            .skip-hint {
                display: none;
            }
        }

        /* Touch feedback animation */
        .card.selected {
            animation: selectPulse 0.2s ease;
        }

        @keyframes selectPulse {
            0% { transform: scale(1); }
            50% { transform: scale(0.96); }
            100% { transform: scale(1); }
        }

        /* Loading state */
        .card img.loading {
            opacity: 0.5;
        }

        /* Error state */
        .error-message {
            text-align: center;
            padding: 40px 20px;
            color: var(--color-accent);
        }

        /* ============================================
           HELP BUTTON & DIALOG
           ============================================ */
        .help-btn {
            position: fixed;
            /* Match theme-toggle vertical position */
            bottom: calc(44px + env(safe-area-inset-bottom, 0px));
            right: max(12px, env(safe-area-inset-right, 0px));
            width: 44px;
            height: 44px;
            border: none;
            border-radius: 50%;
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            color: var(--color-text-muted);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            -webkit-tap-highlight-color: transparent;
            opacity: 0.7;
            z-index: 100;
            backdrop-filter: blur(8px);
        }

        .help-btn:hover {
            opacity: 1;
            transform: scale(1.05);
            background: var(--color-bg);
            color: var(--color-text);
        }

        .help-btn:focus-visible {
            outline: 3px solid var(--color-accent);
            outline-offset: 2px;
        }

        .help-btn:active {
            transform: scale(0.95);
        }

        /* Mobile help button - match theme-toggle positioning */
        @media (max-width: 480px) {
            .help-btn {
                bottom: calc(50px + env(safe-area-inset-bottom, 0px));
                right: max(8px, env(safe-area-inset-right, 0px));
            }
        }

        /* iOS Firefox: larger safe-area buffer */
        @supports (padding: max(0px)) {
            @media (max-width: 480px) {
                .help-btn {
                    bottom: calc(50px + max(8px, env(safe-area-inset-bottom, 0px)));
                }
            }
        }

        .help-dialog {
            position: fixed;
            inset: 0;
            width: 100%;
            height: 100%;
            max-width: 100%;
            max-height: 100%;
            background: rgba(0, 0, 0, 0.8);
            border: none;
            padding: 0;
            margin: 0;
            z-index: 2100;
        }

        .help-dialog::backdrop {
            background: rgba(0, 0, 0, 0.8);
        }

        .help-dialog[open] {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .help-dialog-content {
            background: var(--color-bg);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            width: 90vw;
            max-width: 420px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
        }

        .help-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            border-bottom: 1px solid var(--color-border);
        }

        .help-header h2 {
            font-size: 1rem;
            font-weight: 600;
            color: var(--color-text);
            margin: 0;
        }

        .help-close {
            /* 44px minimum touch target */
            width: 44px;
            height: 44px;
            border: none;
            background: var(--color-surface);
            border-radius: 50%;
            color: var(--color-text-muted);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s, color 0.2s;
            font-size: 1.2rem;
        }

        .help-close:hover {
            background: var(--color-border);
            color: var(--color-text);
        }

        .help-close:focus-visible {
            outline: 2px solid var(--color-accent);
            outline-offset: 2px;
        }

        .help-messages {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            min-height: 200px;
            max-height: 400px;
        }

        .help-msg {
            padding: 12px 16px;
            border-radius: var(--radius-md);
            font-size: 0.9rem;
            line-height: 1.5;
            max-width: 85%;
            word-wrap: break-word;
        }

        .help-msg--system {
            background: var(--color-surface);
            color: var(--color-text);
            align-self: flex-start;
            border: 1px solid var(--color-border);
        }

        .help-msg--user {
            background: linear-gradient(135deg, var(--color-accent-alt), var(--color-accent));
            color: white;
            align-self: flex-end;
        }

        .help-input-form {
            display: flex;
            gap: 8px;
            padding: 16px;
            border-top: 1px solid var(--color-border);
        }

        .help-input {
            flex: 1;
            padding: 12px 16px;
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: 24px;
            color: var(--color-text);
            /* 16px minimum prevents iOS zoom on focus */
            font-size: 16px;
            font-family: inherit;
            min-height: var(--touch-target);
            -webkit-text-size-adjust: 100%;
            touch-action: manipulation;
            transition: border-color 0.2s;
        }

        .help-input::placeholder {
            color: var(--color-text-dim);
        }

        .help-input:focus {
            outline: none;
            border-color: var(--color-accent);
        }

        .help-submit {
            padding: 12px 20px;
            background: var(--color-accent);
            border: none;
            border-radius: 24px;
            color: white;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: filter 0.2s, transform 0.2s;
            min-height: var(--touch-target);
        }

        .help-submit:hover:not(:disabled) {
            filter: brightness(1.1);
        }

        .help-submit:active:not(:disabled) {
            transform: scale(0.95);
        }

        .help-submit:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .help-submit:focus-visible {
            outline: 2px solid white;
            outline-offset: 2px;
        }

        /* ============================================
           IMAGINE BAR (pinned at bottom)
           ============================================ */
        .imagine-bar {
            position: relative;
            margin: 32px auto calc(16px + env(safe-area-inset-bottom, 0px));
            background: var(--color-bg);
            border: 1px solid var(--color-border);
            border-radius: 24px;
            padding: 12px 20px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.2);
            z-index: 900;
            font-size: 0.85rem;
            color: var(--color-text-muted);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            cursor: pointer;
            transition: all 0.2s;
            max-width: calc(100vw - 32px);
            width: fit-content;
        }

        .imagine-bar:hover {
            border-color: var(--color-accent);
            color: var(--color-text);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }

        .imagine-bar svg {
            color: var(--color-accent-alt);
            flex-shrink: 0;
        }

        .imagine-bar span {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        @media (max-width: 480px) {
            .imagine-bar {
                padding: 10px 16px;
                font-size: 0.8rem;
                gap: 8px;
            }
        }

        /* ============================================
           SKELETON LOADING
           ============================================ */
        .skeleton {
            position: relative;
            overflow: hidden;
            background: var(--color-bg-alt);
        }

        .skeleton::after {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(
                90deg,
                transparent 0%,
                rgba(255, 255, 255, 0.06) 50%,
                transparent 100%
            );
            animation: shimmer 1.5s infinite;
        }

        [data-theme="light"] .skeleton::after {
            background: linear-gradient(
                90deg,
                transparent 0%,
                rgba(0, 0, 0, 0.04) 50%,
                transparent 100%
            );
        }

        @media (prefers-color-scheme: light) {
            :root:not([data-theme]) .skeleton::after {
                background: linear-gradient(
                    90deg,
                    transparent 0%,
                    rgba(0, 0, 0, 0.04) 50%,
                    transparent 100%
                );
            }
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        @media (prefers-reduced-motion: reduce) {
            .skeleton::after {
                animation: none;
                background: transparent;
            }
        }

        .card img.skeleton {
            opacity: 1;
        }

        .card img:not(.skeleton) {
            transition: opacity 0.2s ease;
        }

    </style>
    <!-- Fuse.js for fuzzy FAQ matching -->
    <script src="https://cdn.jsdelivr.net/npm/fuse.js@7.0.0/dist/fuse.min.js" integrity="sha384-PCSoOZTpbkikBEtd/+uV3WNdc676i9KUf01KOA8CnJotvlx8rRrETbDuwdjqTYvt" crossorigin="anonymous"></script>
</head>
<body>
    <!-- Skip link for keyboard/screen reader users -->
    <a href="#main-content" class="skip-link">Skip to voting</a>

    <!-- Live region for screen reader announcements -->
    <div id="announcer" class="sr-only" aria-live="polite" aria-atomic="true"></div>

    <div class="container">
        <header>
            <!-- Production branding -->
            <span class="production-brand">
                <span class="brand-faded">an </span><span class="brand-shimmer">Uncle Elmo</span><span class="brand-faded"> production</span>
                <svg class="elmo-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64" aria-hidden="true">
                    <circle cx="32" cy="32" r="30" fill="#1a1a1a"/>
                    <g transform="rotate(30, 32, 32)">
                        <ellipse cx="25" cy="18" rx="10" ry="11" fill="white"/>
                        <ellipse cx="39" cy="18" rx="10" ry="11" fill="white"/>
                        <circle cx="28" cy="18" r="4.5" fill="#1a1a1a"/>
                        <circle cx="36" cy="18" r="4.5" fill="#1a1a1a"/>
                        <ellipse cx="32" cy="40" rx="9" ry="6" fill="white"/>
                        <path d="M 18 52 Q 32 62 46 52" fill="none" stroke="white" stroke-width="3" stroke-linecap="round"/>
                    </g>
                </svg>
            </span>
            <h1>Christmas Stories</h1>
            <!-- Elf button (floating) - feedback & suggestions -->
            <button class="help-btn" id="helpBtn" aria-label="Talk to the Elf" title="Elf">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                    <path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/>
                </svg>
            </button>
            <button
                type="button"
                class="theme-toggle"
                id="themeToggle"
                aria-label="Switch to light mode"
                title="Toggle theme"
            >
                <!-- Sun icon (shown in dark mode - click to switch to light) -->
                <svg class="icon-sun" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                    <circle cx="12" cy="12" r="5"/>
                    <line x1="12" y1="1" x2="12" y2="3"/>
                    <line x1="12" y1="21" x2="12" y2="23"/>
                    <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/>
                    <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/>
                    <line x1="1" y1="12" x2="3" y2="12"/>
                    <line x1="21" y1="12" x2="23" y2="12"/>
                    <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/>
                    <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
                </svg>
                <!-- Moon icon (shown in light mode - click to switch to dark) -->
                <svg class="icon-moon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                    <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                </svg>
            </button>
            <div class="stats" role="group" aria-label="Statistics">
                <span>Votes: <strong id="voteCount" aria-live="polite">0</strong></span>
                <span>Images: <strong id="imageCount">0</strong></span>
            </div>
        </header>

        <nav class="tabs" role="tablist" aria-label="View selection">
            <button class="tab active" role="tab" aria-selected="true" aria-controls="arena-panel" id="tab-arena" data-view="arena" tabindex="0">Vote</button>
            <button class="tab" role="tab" aria-selected="false" aria-controls="leaderboard-panel" id="tab-leaderboard" data-view="leaderboard" tabindex="-1">Rankings</button>
        </nav>

        <main id="main-content">
            <div class="arena-view" id="arena-panel" role="tabpanel" aria-labelledby="tab-arena">
                <p class="instructions" id="vote-instructions">Click or tap the image you prefer</p>

                <div class="arena" role="group" aria-labelledby="vote-instructions">
                    <button class="card" id="cardLeft" type="button" aria-label="Vote for left image" tabindex="0">
                        <img id="imgLeft" src="" alt="Loading left comparison image..." loading="eager" width="1408" height="768">
                        <div class="card-info">
                            <div class="card-title" id="titleLeft">Loading...</div>
                            <div class="card-elo" id="eloLeft" aria-label="Elo rating">1500</div>
                        </div>
                    </button>

                    <div class="vs" aria-hidden="true">VS</div>

                    <button class="card" id="cardRight" type="button" aria-label="Vote for right image" tabindex="0">
                        <img id="imgRight" src="" alt="Loading right comparison image..." loading="eager" width="1408" height="768">
                        <div class="card-info">
                            <div class="card-title" id="titleRight">Loading...</div>
                            <div class="card-elo" id="eloRight" aria-label="Elo rating">1500</div>
                        </div>
                    </button>
                </div>

                <p class="skip-hint">Press <kbd>S</kbd> to skip &bull; Arrow keys to vote</p>
            </div>

            <div class="leaderboard" id="leaderboard-panel" role="tabpanel" aria-labelledby="tab-leaderboard" aria-label="Image rankings" hidden></div>
        </main>

        <!-- Footer -->
        <footer class="site-footer">
        </footer>

        <!-- Imagine bar (at bottom of page content) -->
        <button class="imagine-bar" id="imagineBar" aria-label="Suggest new scenes">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                <path d="M12 3l1.5 4.5L18 9l-4.5 1.5L12 15l-1.5-4.5L6 9l4.5-1.5L12 3z"/>
            </svg>
            <span>Coming soon! Tap <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true" style="vertical-align: middle; margin: 0 2px;"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/></svg> for more</span>
        </button>
    </div>

    <!-- Help/FAQ dialog -->
    <dialog class="help-dialog" id="helpDialog">
        <div class="help-dialog-content">
            <header class="help-header">
                <h2>Help & Feedback</h2>
                <button class="help-close" id="helpClose" aria-label="Close">&times;</button>
            </header>
            <div class="help-messages" id="helpMessages" aria-live="polite" aria-atomic="false">
                <div class="help-msg help-msg--system">
                    Hi there! I'm the Christmas Stories helper elf. Ask me anything about voting, rankings, or how the app works - or share your ideas for new features!
                </div>
            </div>
            <form class="help-input-form" id="helpForm">
                <input
                    type="text"
                    class="help-input"
                    id="helpInput"
                    placeholder="Ask a question or report an issue..."
                    maxlength="500"
                    aria-label="Type your message"
                >
                <button type="submit" class="help-submit">Send</button>
            </form>
        </div>
    </dialog>

    <!-- Image lightbox for rankings -->
    <dialog class="lightbox" id="imageLightbox">
        <div class="lightbox-content">
            <img id="lightboxImg" src="" alt="" width="1408" height="768">
            <p style="color: rgba(255,255,255,0.5); font-size: 0.75rem; margin: 0;">Tap image to zoom</p>
            <div class="lightbox-actions">
                <button id="lightboxShare" class="lightbox-btn">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M4 12v8a2 2 0 002 2h12a2 2 0 002-2v-8M16 6l-4-4-4 4M12 2v13"/>
                    </svg>
                    Share
                </button>
                <a id="lightboxDownload" href="" download="" class="lightbox-btn">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5 5 5-5M12 15V3"/>
                    </svg>
                    Download
                </a>
                <button id="lightboxClose" class="lightbox-btn lightbox-btn--close">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 6L6 18M6 6l12 12"/>
                    </svg>
                    Close
                </button>
            </div>
        </div>
    </dialog>

    <!-- Share menu dialog -->
    <dialog class="share-menu" id="shareMenu">
        <div class="share-menu-header">
            <h3>Share Image</h3>
            <button class="share-menu-close" id="shareMenuClose" aria-label="Close">&times;</button>
        </div>
        <div class="share-menu-preview">
            <img id="sharePreviewImg" src="" alt="">
            <div class="share-menu-preview-text" id="sharePreviewText"></div>
        </div>
        <div class="share-options">
            <button class="share-option" data-platform="facebook">
                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/></svg>
                Facebook
            </button>
            <button class="share-option" data-platform="instagram">
                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/></svg>
                Instagram
            </button>
            <button class="share-option" data-platform="pinterest">
                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12.017 0C5.396 0 .029 5.367.029 11.987c0 5.079 3.158 9.417 7.618 11.162-.105-.949-.199-2.403.041-3.439.219-.937 1.406-5.957 1.406-5.957s-.359-.72-.359-1.781c0-1.663.967-2.911 2.168-2.911 1.024 0 1.518.769 1.518 1.688 0 1.029-.653 2.567-.992 3.992-.285 1.193.6 2.165 1.775 2.165 2.128 0 3.768-2.245 3.768-5.487 0-2.861-2.063-4.869-5.008-4.869-3.41 0-5.409 2.562-5.409 5.199 0 1.033.394 2.143.889 2.741.099.12.112.225.085.345-.09.375-.293 1.199-.334 1.363-.053.225-.172.271-.401.165-1.495-.69-2.433-2.878-2.433-4.646 0-3.776 2.748-7.252 7.92-7.252 4.158 0 7.392 2.967 7.392 6.923 0 4.135-2.607 7.462-6.233 7.462-1.214 0-2.354-.629-2.758-1.379l-.749 2.848c-.269 1.045-1.004 2.352-1.498 3.146 1.123.345 2.306.535 3.55.535 6.607 0 11.985-5.365 11.985-11.987C23.97 5.39 18.592.026 11.985.026L12.017 0z"/></svg>
                Pinterest
            </button>
            <button class="share-option" data-platform="whatsapp">
                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg>
                WhatsApp
            </button>
            <button class="share-option" data-platform="signal">
                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 0C5.373 0 0 5.373 0 12s5.373 12 12 12 12-5.373 12-12S18.627 0 12 0zm5.894 8.221l-1.97 9.28c-.145.658-.537.818-1.084.508l-3-2.21-1.446 1.394c-.14.18-.357.295-.6.295-.002 0-.003 0-.005 0l.213-3.054 5.56-5.022c.24-.213-.054-.334-.373-.121l-6.869 4.326-2.96-.924c-.64-.203-.658-.64.135-.954l11.566-4.458c.538-.196 1.006.128.832.94z"/></svg>
                Signal
            </button>
            <button class="share-option" data-platform="copy">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></svg>
                Copy Link
            </button>
        </div>
    </dialog>

    <script>
        'use strict';

        // ============================================
        // VISITOR ID (Anonymous Fingerprinting)
        // ============================================
        const LOCAL_ID_KEY = 'bearRanker_visitorId';

        function getVisitorId() {
            let id = localStorage.getItem(LOCAL_ID_KEY);
            if (!id) {
                id = 'visitor_' + crypto.randomUUID();
                localStorage.setItem(LOCAL_ID_KEY, id);
            }
            return id;
        }

        const visitorId = getVisitorId();

        // Firebase API stub - replace with real Firebase when deployed
        // For now, all data stays local. When you add Firebase:
        // 1. Add Firebase SDK scripts
        // 2. Replace these stubs with real implementations
        window.firebaseAPI = {
            isReady: () => false,  // Set to true when Firebase configured
            getVisitorId: () => visitorId,
            submitVote: async () => false,
            submitFeedback: async () => false,
            submitSuggestion: async () => false,
            resetIdentity: () => {
                localStorage.removeItem(LOCAL_ID_KEY);
                location.reload();
            }
        };

        // ============================================
        // SECURITY: Sanitize text for display
        // ============================================
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ============================================
        // CONFIGURATION
        // ============================================
        const IMAGE_BASE = './images/';

        // Image catalog with display names and descriptions
        const IMAGE_CATALOG = {
            "01_child_shares.png": { displayName: "Shared Joy", description: "Child sharing with whale", category: "whale" },
            "01_folding_together.png": { displayName: "Folding Day", description: "Folding laundry together", category: "whale" },
            "01_laundromat.png": { displayName: "Spin Cycle", description: "Whale at laundromat", category: "whale" },
            "01_lighthouse_keeper.png": { displayName: "Keeper's Light", description: "Lighthouse keeper whale", category: "whale" },
            "01_rooftop_dawn.png": { displayName: "Dawn Watch", description: "Whale at rooftop dawn", category: "whale" },
            "01_sharing_bench.png": { displayName: "Shared Bench", description: "Sharing a park bench", category: "whale" },
            "01_train_platform.png": { displayName: "Morning Platform", description: "Whale at train platform", category: "whale" },
            "01_window_looking_in.png": { displayName: "Outside Looking", description: "Whale looking through window", category: "whale" },
            "02_apartment_landing.png": { displayName: "Landing Rest", description: "Whale on apartment landing", category: "whale" },
            "02_busker_duet.png": { displayName: "Street Duet", description: "Busker duet with whale", category: "whale" },
            "02_cafe_window.png": { displayName: "Cafe Moment", description: "Whale at cafe window", category: "whale" },
            "02_empty_theater.png": { displayName: "Empty House", description: "Whale in empty theater", category: "whale" },
            "02_lost_sock_search.png": { displayName: "Lost Sock", description: "Lost sock search together", category: "whale" },
            "02_night_bus.png": { displayName: "Night Route", description: "Whale on night bus", category: "whale" },
            "02_platform_vendor.png": { displayName: "Platform Snack", description: "Whale with platform vendor", category: "whale" },
            "02_seagull_friend.png": { displayName: "Unlikely Friends", description: "Whale befriends a seagull", category: "whale" },
            "03_bookshop_reader.png": { displayName: "Between Pages", description: "Whale reading in bookshop", category: "whale" },
            "03_ferry_deck.png": { displayName: "Deck Passage", description: "Whale on ferry deck", category: "whale" },
            "03_hospital_corridor.png": { displayName: "Quiet Corridor", description: "Whale in hospital corridor", category: "whale" },
            "03_kitchen_table.png": { displayName: "Kitchen Light", description: "Whale at kitchen table", category: "whale" },
            "03_lost_child_found.png": { displayName: "Found Again", description: "Whale finds lost child", category: "whale" },
            "03_phone_booth.png": { displayName: "Distant Call", description: "Whale in phone booth", category: "whale" },
            "03_seasick_comfort.png": { displayName: "Rough Seas", description: "Comforting seasick friend", category: "whale" },
            "03_sleeping_child.png": { displayName: "Gentle Watch", description: "Whale with sleeping child", category: "whale" },
            "04_deck_hands_break.png": { displayName: "Crew Break", description: "Deck hands taking break", category: "whale" },
            "04_porter_assistance.png": { displayName: "Helping Hand", description: "Whale helping as porter", category: "whale" },
            "04_stray_cat_company.png": { displayName: "Stray Company", description: "Whale with stray cat", category: "whale" },
            "05_teaching_quarters.png": { displayName: "Lesson Time", description: "Whale in teaching quarters", category: "whale" },
            "05_train_window_wave.png": { displayName: "Window Wave", description: "Waving from train window", category: "whale" },
            "05_violin_on_water.png": { displayName: "Water Song", description: "Violin playing on water", category: "whale" },
            "06_closing_time.png": { displayName: "Closing Time", description: "Whale at closing time", category: "whale" },
            "06_docking_goodbye.png": { displayName: "Dockside Farewell", description: "Goodbye at the dock", category: "whale" },
            "06_midnight_arrival.png": { displayName: "Midnight Port", description: "Midnight arrival scene", category: "whale" },
            "alive_01_invisible_among_crowd_01_busy_street_082316.png": { displayName: "Unseen Crowd", description: "Invisible on busy street", category: "alive" },
            "alive_01_invisible_among_crowd_02_train_station_082316.png": { displayName: "Station Ghost", description: "Invisible at train station", category: "alive" },
            "alive_02_awkward_interactions_01_bartender_stare_082316.png": { displayName: "Awkward Glance", description: "Bartender staring awkwardly", category: "alive" },
            "alive_02_awkward_interactions_02_bus_driver_082316.png": { displayName: "Driver Pause", description: "Bus driver encounter", category: "alive" },
            "alive_03_one_kind_soul_01_child_waves_082316.png": { displayName: "Kind Wave", description: "Kind child waves hello", category: "alive" },
            "alive_03_one_kind_soul_02_old_man_bench_082316.png": { displayName: "Bench Companion", description: "Old man on bench", category: "alive" },
            "alive_04_complete_solitude_01_empty_playground_082316.png": { displayName: "Empty Swings", description: "Alone in empty playground", category: "alive" },
            "alive_04_complete_solitude_02_closed_shop_082316.png": { displayName: "Closed Hours", description: "Outside closed shop", category: "alive" },
            "animated_01_invisible_crowd_01_shopping_street_082316.png": { displayName: "Shopping Phantom", description: "Invisible on shopping street", category: "animated" },
            "animated_02_awkward_notice_01_hotel_desk_082316.png": { displayName: "Check-In Pause", description: "Noticed at hotel desk", category: "animated" },
            "animated_03_finding_kindness_01_child_secret_082316.png": { displayName: "Whispered Secret", description: "Child shares a secret", category: "animated" },
            "animated_04_total_solitude_01_diner_3am_082316.png": { displayName: "3AM Diner", description: "Alone at 3am diner", category: "animated" },
            "living_01_tiny_hiding_01_sugar_bowl_082316.png": { displayName: "Sugar Hideaway", description: "Tiny bear in sugar bowl", category: "living" },
            "living_01_tiny_hiding_02_coat_pocket_082316.png": { displayName: "Pocket Refuge", description: "Hiding in coat pocket", category: "living" },
            "living_01_tiny_hiding_03_shelf_peek_082316.png": { displayName: "Shelf Spy", description: "Peeking from shelf", category: "living" },
            "living_01_tiny_hiding_04_table_dash_082316.png": { displayName: "Table Dash", description: "Dashing across table", category: "living" },
            "living_02_child_wandering_01_crosswalk_082316.png": { displayName: "Street Crossing", description: "Child bear at crosswalk", category: "living" },
            "living_02_child_wandering_02_diner_slide_082316.png": { displayName: "Booth Slide", description: "Bear sliding in diner", category: "living" },
            "living_02_child_wandering_03_bench_slump_082316.png": { displayName: "Tired Slump", description: "Slumped on bench", category: "living" },
            "living_02_child_wandering_04_door_pushing_082316.png": { displayName: "Heavy Door", description: "Pushing heavy door", category: "living" },
            "living_03_human_confronting_01_bar_lean_082316.png": { displayName: "Bar Lean", description: "Leaning at bar", category: "living" },
            "living_03_human_confronting_02_bus_boarding_082316.png": { displayName: "Boarding Time", description: "Boarding the bus", category: "living" },
            "living_03_human_confronting_03_elevator_nod_082316.png": { displayName: "Elevator Nod", description: "Nodding in elevator", category: "living" },
            "living_03_human_confronting_04_bench_sitting_082316.png": { displayName: "Shared Seat", description: "Sitting on bench", category: "living" },
            "living_03_human_confronting_05_window_reflection_082316.png": { displayName: "Glass Self", description: "Reflection in window", category: "living" },
            "living_04_giant_gentle_01_door_ducking_082316.png": { displayName: "Careful Duck", description: "Giant bear ducking door", category: "living" },
            "living_04_giant_gentle_02_stool_perching_082316.png": { displayName: "Tiny Perch", description: "Perching on small stool", category: "living" },
            "living_04_giant_gentle_03_child_kneeling_082316.png": { displayName: "Gentle Giant", description: "Kneeling beside child", category: "living" },
            "living_04_giant_gentle_04_phone_booth_082316.png": { displayName: "Tight Squeeze", description: "Squeezed in phone booth", category: "living" },
            "realistic_01_tiny_unnoticed_01_cafe_table_082316.png": { displayName: "Cafe Observer", description: "Tiny bear on cafe table", category: "realistic" },
            "realistic_02_child_sized_01_park_bench_082316.png": { displayName: "Park Rest", description: "Child-sized on park bench", category: "realistic" },
            "realistic_02_child_sized_02_diner_booth_082316.png": { displayName: "Diner Guest", description: "Child-sized in diner booth", category: "realistic" },
            "realistic_03_human_scale_01_bar_ordering_082316.png": { displayName: "Last Orders", description: "Human-sized ordering at bar", category: "realistic" },
            "realistic_04_giant_looming_01_convenience_store_082316.png": { displayName: "Corner Store", description: "Giant in convenience store", category: "realistic" },
            "realistic_04_giant_looming_02_subway_car_082316.png": { displayName: "Subway Giant", description: "Giant in subway car", category: "realistic" },
            "solitude_01_alone_in_house_01_frosted_window_082316.png": { displayName: "Frosted View", description: "Alone at frosted window", category: "solitude" },
            "solitude_01_alone_in_house_02_fireplace_082316.png": { displayName: "Hearth Glow", description: "Alone by the fireplace", category: "solitude" },
            "solitude_02_bar_christmas_01_bar_end_082316.png": { displayName: "End Stool", description: "Alone at bar end", category: "solitude" },
            "solitude_02_bar_christmas_02_piano_corner_082316.png": { displayName: "Piano Corner", description: "Alone in piano corner", category: "solitude" },
            "solitude_03_riding_bus_01_rain_window_082316.png": { displayName: "Rain Watch", description: "Watching rain on bus", category: "solitude" },
            "solitude_03_riding_bus_02_back_row_082316.png": { displayName: "Back Row", description: "Alone in back row", category: "solitude" },
            "solitude_04_office_alone_01_desk_lamp_082316.png": { displayName: "Late Shift", description: "Alone at desk lamp", category: "solitude" },
            "styles_01_stop_motion_01_bar_stool_082316.png": { displayName: "Stop-Motion Stool", description: "Stop-motion bar stool", category: "styles" },
            "styles_01_stop_motion_02_bus_window_082316.png": { displayName: "Stop-Motion Window", description: "Stop-motion bus window", category: "styles" },
            "styles_01_stop_motion_03_diner_booth_082316.png": { displayName: "Stop-Motion Booth", description: "Stop-motion diner booth", category: "styles" },
            "styles_01_stop_motion_04_phone_booth_082316.png": { displayName: "Stop-Motion Call", description: "Stop-motion phone booth", category: "styles" },
            "styles_02_claymation_01_park_bench_082316.png": { displayName: "Clay Park", description: "Claymation park bench", category: "styles" },
            "styles_02_claymation_02_subway_platform_082316.png": { displayName: "Clay Platform", description: "Claymation subway platform", category: "styles" },
            "styles_02_claymation_03_laundromat_082316.png": { displayName: "Clay Laundry", description: "Claymation at laundromat", category: "styles" },
            "styles_03_cgi_paddington_01_hotel_lobby_082316.png": { displayName: "CGI Lobby", description: "CGI bear hotel lobby", category: "styles" },
            "styles_03_cgi_paddington_02_train_station_082316.png": { displayName: "CGI Station", description: "CGI bear train station", category: "styles" },
            "styles_03_cgi_paddington_03_cafe_window_082316.png": { displayName: "CGI Cafe", description: "CGI bear cafe window", category: "styles" },
            "styles_04_practical_puppet_01_elevator_082316.png": { displayName: "Puppet Lift", description: "Puppet bear in elevator", category: "styles" },
            "styles_04_practical_puppet_02_hospital_waiting_082316.png": { displayName: "Puppet Wait", description: "Puppet bear hospital waiting", category: "styles" },
            "styles_04_practical_puppet_03_empty_theater_082316.png": { displayName: "Puppet Theater", description: "Puppet bear empty theater", category: "styles" },
            "styles_04_practical_puppet_04_parking_garage_082316.png": { displayName: "Puppet Garage", description: "Puppet bear parking garage", category: "styles" },
            "styles_05_handdrawn_composite_01_city_street_082316.png": { displayName: "Drawn Street", description: "Hand-drawn city street", category: "styles" },
            "styles_05_handdrawn_composite_02_dive_bar_082316.png": { displayName: "Drawn Dive", description: "Hand-drawn dive bar", category: "styles" },
            "styles_05_handdrawn_composite_03_rooftop_082316.png": { displayName: "Drawn Rooftop", description: "Hand-drawn rooftop scene", category: "styles" },
            "styles_06_fabric_stopmotion_01_bookshop_082316.png": { displayName: "Fabric Books", description: "Fabric stop-motion bookshop", category: "styles" },
            "styles_06_fabric_stopmotion_02_late_diner_082316.png": { displayName: "Fabric Diner", description: "Fabric stop-motion late diner", category: "styles" },
            "styles_06_fabric_stopmotion_03_ferry_deck_082316.png": { displayName: "Fabric Ferry", description: "Fabric stop-motion ferry deck", category: "styles" },
            "styles_06_fabric_stopmotion_04_church_pew_082316.png": { displayName: "Fabric Pew", description: "Fabric stop-motion church pew", category: "styles" },
            "teddy_melancholy_01_alone_in_house_01_window_watching_082316.png": { displayName: "Window Vigil", description: "Bear watching from window", category: "teddy" },
            "teddy_melancholy_01_alone_in_house_02_empty_chair_082316.png": { displayName: "Empty Chair", description: "Bear by empty chair", category: "teddy" },
            "teddy_melancholy_01_alone_in_house_03_kitchen_table_082316.png": { displayName: "Kitchen Quiet", description: "Bear at kitchen table", category: "teddy" },
            "teddy_melancholy_01_alone_in_house_04_old_photos_082316.png": { displayName: "Old Memories", description: "Bear looking at old photos", category: "teddy" },
            "teddy_melancholy_01_alone_in_house_05_stairs_sitting_082316.png": { displayName: "Stairway Rest", description: "Bear sitting on stairs", category: "teddy" },
            "teddy_melancholy_01_alone_in_house_06_bedroom_dawn_082316.png": { displayName: "Dawn Light", description: "Bear in bedroom at dawn", category: "teddy" },
            "teddy_melancholy_01_alone_in_house_07_piano_keys_082316.png": { displayName: "Silent Keys", description: "Bear at piano keys", category: "teddy" },
            "teddy_melancholy_01_alone_in_house_08_doorway_leaving_082316.png": { displayName: "Threshold", description: "Bear leaving through doorway", category: "teddy" },
            "teddy_melancholy_02_bar_christmas_01_bar_stool_082316.png": { displayName: "Corner Stool", description: "Sad bear on bar stool", category: "teddy" },
            "teddy_melancholy_02_bar_christmas_02_jukebox_glow_082316.png": { displayName: "Jukebox Glow", description: "Bear by jukebox glow", category: "teddy" },
            "teddy_melancholy_02_bar_christmas_03_bartender_chat_082316.png": { displayName: "Bar Talk", description: "Bear chatting with bartender", category: "teddy" },
            "teddy_melancholy_02_bar_christmas_04_window_booth_082316.png": { displayName: "Booth View", description: "Bear in window booth", category: "teddy" },
            "teddy_melancholy_02_bar_christmas_05_last_call_082316.png": { displayName: "Last Call", description: "Bear at last call", category: "teddy" },
            "teddy_melancholy_02_bar_christmas_06_mirror_behind_bar_082316.png": { displayName: "Mirror Self", description: "Bear reflection behind bar", category: "teddy" },
            "teddy_melancholy_02_bar_christmas_07_payphone_082316.png": { displayName: "Unanswered Call", description: "Bear at payphone", category: "teddy" },
            "teddy_melancholy_02_bar_christmas_08_putting_on_coat_082316.png": { displayName: "Coat On", description: "Bear putting on coat", category: "teddy" },
            "teddy_melancholy_03_riding_bus_01_window_seat_082316.png": { displayName: "Window Seat", description: "Bear in window seat", category: "teddy" },
            "teddy_melancholy_03_riding_bus_02_back_seat_082316.png": { displayName: "Rear View", description: "Bear in back seat", category: "teddy" },
            "teddy_melancholy_03_riding_bus_03_bus_stop_082316.png": { displayName: "Waiting Stop", description: "Bear at bus stop", category: "teddy" },
            "teddy_melancholy_03_riding_bus_04_fluorescent_082316.png": { displayName: "Harsh Light", description: "Bear under fluorescent lights", category: "teddy" },
            "teddy_melancholy_03_riding_bus_05_driver_nod_082316.png": { displayName: "Driver Nod", description: "Bear nodding to driver", category: "teddy" },
            "teddy_melancholy_03_riding_bus_06_shopping_bags_082316.png": { displayName: "Laden Arms", description: "Bear with shopping bags", category: "teddy" },
            "teddy_melancholy_03_riding_bus_07_sleeping_082316.png": { displayName: "Transit Sleep", description: "Bear sleeping on bus", category: "teddy" },
            "teddy_melancholy_03_riding_bus_08_end_of_line_082316.png": { displayName: "End of Line", description: "Bear at end of line", category: "teddy" },
            "teddy_melancholy_04_office_alone_01_desk_lamp_082316.png": { displayName: "Desk Lamp", description: "Bear alone at desk lamp", category: "teddy" },
            "teddy_melancholy_04_office_alone_02_computer_glow_082316.png": { displayName: "Screen Glow", description: "Bear in computer glow", category: "teddy" },
            "teddy_melancholy_04_office_alone_03_break_room_082316.png": { displayName: "Break Room", description: "Bear in break room", category: "teddy" },
            "teddy_melancholy_04_office_alone_04_window_view_082316.png": { displayName: "Office View", description: "Bear at window view", category: "teddy" },
            "teddy_melancholy_04_office_alone_05_conference_room_082316.png": { displayName: "Empty Meeting", description: "Bear in conference room", category: "teddy" },
            "teddy_melancholy_04_office_alone_06_elevator_082316.png": { displayName: "Going Down", description: "Bear alone in elevator", category: "teddy" },
            "teddy_melancholy_04_office_alone_07_parking_garage_082316.png": { displayName: "Parking Concrete", description: "Bear in parking garage", category: "teddy" },
            "teddy_melancholy_04_office_alone_08_security_desk_082316.png": { displayName: "Night Guard", description: "Bear at security desk", category: "teddy" }
        };

        const IMAGE_FILES = [
            'alive_01_invisible_among_crowd_01_busy_street_082316.png',
            'alive_01_invisible_among_crowd_02_train_station_082316.png',
            'alive_02_awkward_interactions_01_bartender_stare_082316.png',
            'alive_02_awkward_interactions_02_bus_driver_082316.png',
            'alive_03_one_kind_soul_01_child_waves_082316.png',
            'alive_03_one_kind_soul_02_old_man_bench_082316.png',
            'alive_04_complete_solitude_01_empty_playground_082316.png',
            'alive_04_complete_solitude_02_closed_shop_082316.png',
            'animated_01_invisible_crowd_01_shopping_street_082316.png',
            'animated_02_awkward_notice_01_hotel_desk_082316.png',
            'animated_03_finding_kindness_01_child_secret_082316.png',
            'animated_04_total_solitude_01_diner_3am_082316.png',
            'living_01_tiny_hiding_01_sugar_bowl_082316.png',
            'living_01_tiny_hiding_02_coat_pocket_082316.png',
            'living_01_tiny_hiding_03_shelf_peek_082316.png',
            'living_01_tiny_hiding_04_table_dash_082316.png',
            'living_02_child_wandering_01_crosswalk_082316.png',
            'living_02_child_wandering_02_diner_slide_082316.png',
            'living_02_child_wandering_03_bench_slump_082316.png',
            'living_02_child_wandering_04_door_pushing_082316.png',
            'living_03_human_confronting_01_bar_lean_082316.png',
            'living_03_human_confronting_02_bus_boarding_082316.png',
            'living_03_human_confronting_03_elevator_nod_082316.png',
            'living_03_human_confronting_04_bench_sitting_082316.png',
            'living_03_human_confronting_05_window_reflection_082316.png',
            'living_04_giant_gentle_01_door_ducking_082316.png',
            'living_04_giant_gentle_02_stool_perching_082316.png',
            'living_04_giant_gentle_03_child_kneeling_082316.png',
            'living_04_giant_gentle_04_phone_booth_082316.png',
            'realistic_01_tiny_unnoticed_01_cafe_table_082316.png',
            'realistic_02_child_sized_01_park_bench_082316.png',
            'realistic_02_child_sized_02_diner_booth_082316.png',
            'realistic_03_human_scale_01_bar_ordering_082316.png',
            'realistic_04_giant_looming_01_convenience_store_082316.png',
            'realistic_04_giant_looming_02_subway_car_082316.png',
            'solitude_01_alone_in_house_01_frosted_window_082316.png',
            'solitude_01_alone_in_house_02_fireplace_082316.png',
            'solitude_02_bar_christmas_01_bar_end_082316.png',
            'solitude_02_bar_christmas_02_piano_corner_082316.png',
            'solitude_03_riding_bus_01_rain_window_082316.png',
            'solitude_03_riding_bus_02_back_row_082316.png',
            'solitude_04_office_alone_01_desk_lamp_082316.png',
            'styles_01_stop_motion_01_bar_stool_082316.png',
            'styles_01_stop_motion_02_bus_window_082316.png',
            'styles_01_stop_motion_03_diner_booth_082316.png',
            'styles_01_stop_motion_04_phone_booth_082316.png',
            'styles_02_claymation_01_park_bench_082316.png',
            'styles_02_claymation_02_subway_platform_082316.png',
            'styles_02_claymation_03_laundromat_082316.png',
            'styles_03_cgi_paddington_01_hotel_lobby_082316.png',
            'styles_03_cgi_paddington_02_train_station_082316.png',
            'styles_03_cgi_paddington_03_cafe_window_082316.png',
            'styles_04_practical_puppet_01_elevator_082316.png',
            'styles_04_practical_puppet_02_hospital_waiting_082316.png',
            'styles_04_practical_puppet_03_empty_theater_082316.png',
            'styles_04_practical_puppet_04_parking_garage_082316.png',
            'styles_05_handdrawn_composite_01_city_street_082316.png',
            'styles_05_handdrawn_composite_02_dive_bar_082316.png',
            'styles_05_handdrawn_composite_03_rooftop_082316.png',
            'styles_06_fabric_stopmotion_01_bookshop_082316.png',
            'styles_06_fabric_stopmotion_02_late_diner_082316.png',
            'styles_06_fabric_stopmotion_03_ferry_deck_082316.png',
            'styles_06_fabric_stopmotion_04_church_pew_082316.png',
            'teddy_melancholy_01_alone_in_house_01_window_watching_082316.png',
            'teddy_melancholy_01_alone_in_house_02_empty_chair_082316.png',
            'teddy_melancholy_01_alone_in_house_03_kitchen_table_082316.png',
            'teddy_melancholy_01_alone_in_house_04_old_photos_082316.png',
            'teddy_melancholy_01_alone_in_house_05_stairs_sitting_082316.png',
            'teddy_melancholy_01_alone_in_house_06_bedroom_dawn_082316.png',
            'teddy_melancholy_01_alone_in_house_07_piano_keys_082316.png',
            'teddy_melancholy_01_alone_in_house_08_doorway_leaving_082316.png',
            'teddy_melancholy_02_bar_christmas_01_bar_stool_082316.png',
            'teddy_melancholy_02_bar_christmas_02_jukebox_glow_082316.png',
            'teddy_melancholy_02_bar_christmas_03_bartender_chat_082316.png',
            'teddy_melancholy_02_bar_christmas_04_window_booth_082316.png',
            'teddy_melancholy_02_bar_christmas_05_last_call_082316.png',
            'teddy_melancholy_02_bar_christmas_06_mirror_behind_bar_082316.png',
            'teddy_melancholy_02_bar_christmas_07_payphone_082316.png',
            'teddy_melancholy_02_bar_christmas_08_putting_on_coat_082316.png',
            'teddy_melancholy_03_riding_bus_01_window_seat_082316.png',
            'teddy_melancholy_03_riding_bus_02_back_seat_082316.png',
            'teddy_melancholy_03_riding_bus_03_bus_stop_082316.png',
            'teddy_melancholy_03_riding_bus_04_fluorescent_082316.png',
            'teddy_melancholy_03_riding_bus_05_driver_nod_082316.png',
            'teddy_melancholy_03_riding_bus_06_shopping_bags_082316.png',
            'teddy_melancholy_03_riding_bus_07_sleeping_082316.png',
            'teddy_melancholy_03_riding_bus_08_end_of_line_082316.png',
            'teddy_melancholy_04_office_alone_01_desk_lamp_082316.png',
            'teddy_melancholy_04_office_alone_02_computer_glow_082316.png',
            'teddy_melancholy_04_office_alone_03_break_room_082316.png',
            'teddy_melancholy_04_office_alone_04_window_view_082316.png',
            'teddy_melancholy_04_office_alone_05_conference_room_082316.png',
            'teddy_melancholy_04_office_alone_06_elevator_082316.png',
            'teddy_melancholy_04_office_alone_07_parking_garage_082316.png',
            'teddy_melancholy_04_office_alone_08_security_desk_082316.png',
            // Whale animated series
            '01_child_shares.png',
            '01_folding_together.png',
            '01_laundromat.png',
            '01_lighthouse_keeper.png',
            '01_rooftop_dawn.png',
            '01_sharing_bench.png',
            '01_train_platform.png',
            '01_window_looking_in.png',
            '02_apartment_landing.png',
            '02_busker_duet.png',
            '02_cafe_window.png',
            '02_empty_theater.png',
            '02_lost_sock_search.png',
            '02_night_bus.png',
            '02_platform_vendor.png',
            '02_seagull_friend.png',
            '03_bookshop_reader.png',
            '03_ferry_deck.png',
            '03_hospital_corridor.png',
            '03_kitchen_table.png',
            '03_lost_child_found.png',
            '03_phone_booth.png',
            '03_seasick_comfort.png',
            '03_sleeping_child.png',
            '04_deck_hands_break.png',
            '04_porter_assistance.png',
            '04_stray_cat_company.png',
            '05_teaching_quarters.png',
            '05_train_window_wave.png',
            '05_violin_on_water.png',
            '06_closing_time.png',
            '06_docking_goodbye.png',
            '06_midnight_arrival.png',
        ];

        // Build images array with validation, using catalog for display names
        const images = IMAGE_FILES
            .filter(f => typeof f === 'string' && f.endsWith('.png'))
            .map(f => {
                const catalog = IMAGE_CATALOG[f] || {};
                return {
                    id: f.replace('.png', ''),
                    src: IMAGE_BASE + encodeURIComponent(f),
                    name: catalog.displayName || f.replace('.png', '').replace(/_/g, ' ').replace(/082316$/, '').trim(),
                    description: catalog.description || '',
                    category: catalog.category || 'unknown'
                };
            });

        // ============================================
        // ELO SYSTEM
        // ============================================
        const K_FACTOR = 32;
        const DEFAULT_ELO = 1500;
        const STORAGE_KEY = 'bearRankerData_v1';
        const MAX_MATCHES = 10000; // Prevent localStorage bloat

        let state = {
            ratings: {},
            matches: [],
            currentPair: null
        };

        // Validate loaded data structure
        function isValidState(data) {
            if (!data || typeof data !== 'object') return false;
            if (!data.ratings || typeof data.ratings !== 'object') return false;
            if (!Array.isArray(data.matches)) return false;
            return true;
        }

        function loadState() {
            try {
                const saved = localStorage.getItem(STORAGE_KEY);
                if (saved) {
                    const parsed = JSON.parse(saved);
                    if (isValidState(parsed)) {
                        // Validate ratings are numbers
                        state.ratings = {};
                        for (const [key, val] of Object.entries(parsed.ratings)) {
                            if (typeof val === 'number' && !isNaN(val)) {
                                state.ratings[key] = Math.round(val);
                            }
                        }
                        // Validate matches array
                        state.matches = parsed.matches
                            .filter(m => m && typeof m.winner === 'string' && typeof m.loser === 'string')
                            .slice(-MAX_MATCHES);
                    }
                }
            } catch (e) {
                console.warn('Failed to load state, starting fresh:', e);
                state.ratings = {};
                state.matches = [];
            }

            // Ensure all images have ratings
            images.forEach(img => {
                if (!(img.id in state.ratings)) {
                    state.ratings[img.id] = DEFAULT_ELO;
                }
            });
        }

        function saveState() {
            try {
                // Trim matches if too many
                if (state.matches.length > MAX_MATCHES) {
                    state.matches = state.matches.slice(-MAX_MATCHES);
                }
                localStorage.setItem(STORAGE_KEY, JSON.stringify({
                    ratings: state.ratings,
                    matches: state.matches
                }));
            } catch (e) {
                console.error('Failed to save state:', e);
                announce('Failed to save. Storage may be full.');
            }
        }

        function expectedScore(ratingA, ratingB) {
            return 1 / (1 + Math.pow(10, (ratingB - ratingA) / 400));
        }

        function updateRatings(winnerId, loserId) {
            const winnerRating = state.ratings[winnerId] || DEFAULT_ELO;
            const loserRating = state.ratings[loserId] || DEFAULT_ELO;

            const expectedWin = expectedScore(winnerRating, loserRating);
            const expectedLose = expectedScore(loserRating, winnerRating);

            state.ratings[winnerId] = Math.round(winnerRating + K_FACTOR * (1 - expectedWin));
            state.ratings[loserId] = Math.round(loserRating + K_FACTOR * (0 - expectedLose));

            state.matches.push({
                winner: winnerId,
                loser: loserId,
                timestamp: Date.now()
            });

            saveState();
        }

        // ============================================
        // ACCESSIBILITY: Screen reader announcements
        // ============================================
        function announce(message) {
            const announcer = document.getElementById('announcer');
            if (announcer) {
                announcer.textContent = message;
                // Clear after announcement
                setTimeout(() => { announcer.textContent = ''; }, 1000);
            }
        }

        // ============================================
        // UI
        // ============================================
        // Round-robin queue ensures all images shown before repeats
        let unseenQueue = [];

        function shuffleArray(arr) {
            const shuffled = [...arr];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }

        function refillQueue() {
            unseenQueue = shuffleArray(images);
        }

        function getRandomPair() {
            if (images.length < 2) return null;

            // Ensure we have at least 2 images in queue
            if (unseenQueue.length < 2) {
                refillQueue();
            }

            // Pop first image
            const first = unseenQueue.pop();

            // Try to find a second image from a DIFFERENT category (better variety)
            let secondIdx = -1;
            for (let i = unseenQueue.length - 1; i >= 0; i--) {
                if (unseenQueue[i].category !== first.category) {
                    secondIdx = i;
                    break;
                }
            }

            // If no different category found, just take the next one
            let second;
            if (secondIdx >= 0) {
                second = unseenQueue.splice(secondIdx, 1)[0];
            } else {
                second = unseenQueue.pop();
            }

            return Math.random() > 0.5 ? [first, second] : [second, first];
        }

        function showPair() {
            const pair = getRandomPair();
            if (!pair) {
                announce('Not enough images to compare');
                return;
            }

            const [left, right] = pair;
            state.currentPair = { left, right };

            const imgLeft = document.getElementById('imgLeft');
            const imgRight = document.getElementById('imgRight');

            // Add skeleton loading state
            imgLeft.classList.add('skeleton');
            imgRight.classList.add('skeleton');

            // Set up load handlers to remove skeleton
            const handleLoad = (img) => {
                img.classList.remove('skeleton');
            };
            imgLeft.onload = () => handleLoad(imgLeft);
            imgRight.onload = () => handleLoad(imgRight);

            imgLeft.src = left.src;
            imgLeft.alt = left.description ? `${left.name}: ${left.description}` : left.name;
            document.getElementById('titleLeft').textContent = left.name;
            document.getElementById('eloLeft').textContent = state.ratings[left.id];

            imgRight.src = right.src;
            imgRight.alt = right.description ? `${right.name}: ${right.description}` : right.name;
            document.getElementById('titleRight').textContent = right.name;
            document.getElementById('eloRight').textContent = state.ratings[right.id];

            // Add error handlers for image loading failures
            imgLeft.onerror = () => { imgLeft.alt = 'Image failed to load'; imgLeft.classList.remove('skeleton'); };
            imgRight.onerror = () => { imgRight.alt = 'Image failed to load'; imgRight.classList.remove('skeleton'); };

            // Update aria-labels
            document.getElementById('cardLeft').setAttribute('aria-label', `Vote for ${left.name}`);
            document.getElementById('cardRight').setAttribute('aria-label', `Vote for ${right.name}`);
        }

        function updateStats() {
            document.getElementById('voteCount').textContent = state.matches.length;
            document.getElementById('imageCount').textContent = images.length;
        }

        // Track current rankings view mode
        let rankingsViewMode = 'personal'; // 'personal' or 'global'

        function renderLeaderboard(mode = rankingsViewMode) {
            rankingsViewMode = mode;
            const container = document.getElementById('leaderboard-panel');
            container.innerHTML = '';

            // Create header with toggle buttons
            const header = document.createElement('div');
            header.className = 'rankings-header';
            header.innerHTML = `
                <div class="rankings-title">${mode === 'global' ? 'Community Rankings' : 'Your Rankings'}</div>
                <div class="rankings-header-actions">
                    <div class="rankings-toggle" role="group" aria-label="Rankings view">
                        <button class="rankings-toggle-btn ${mode === 'personal' ? 'active' : ''}" data-mode="personal" aria-pressed="${mode === 'personal'}">Mine</button>
                        <button class="rankings-toggle-btn ${mode === 'global' ? 'active' : ''}" data-mode="global" aria-pressed="${mode === 'global'}">Global</button>
                    </div>
                    <button class="share-btn" id="shareRankingsBtn" aria-label="Share rankings" title="Share rankings">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                            <path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"/>
                            <polyline points="16,6 12,2 8,6"/>
                            <line x1="12" y1="2" x2="12" y2="15"/>
                        </svg>
                    </button>
                </div>
            `;
            container.appendChild(header);

            // Add toggle event listeners
            header.querySelectorAll('.rankings-toggle-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const newMode = btn.dataset.mode;
                    if (newMode !== rankingsViewMode) {
                        renderLeaderboard(newMode);
                    }
                });
            });

            // Add share rankings handler
            const shareBtn = header.querySelector('#shareRankingsBtn');
            if (shareBtn) {
                shareBtn.addEventListener('click', shareRankings);
            }

            if (mode === 'global') {
                renderGlobalLeaderboard(container);
            } else {
                renderPersonalLeaderboard(container);
            }
        }

        async function renderPersonalLeaderboard(container) {
            // Pre-compute win/loss in O(n+m) instead of O(n*m)
            const stats = {};
            images.forEach(img => { stats[img.id] = { wins: 0, losses: 0 }; });
            state.matches.forEach(m => {
                if (stats[m.winner]) stats[m.winner].wins++;
                if (stats[m.loser]) stats[m.loser].losses++;
            });

            // Shuffle first so equal-rated images appear in random order
            const shuffled = shuffleArray(images);
            const sorted = shuffled
                .map(img => ({
                    ...img,
                    elo: state.ratings[img.id] || DEFAULT_ELO,
                    wins: stats[img.id]?.wins || 0,
                    losses: stats[img.id]?.losses || 0
                }))
                .sort((a, b) => b.elo - a.elo);

            // Fetch global rankings for comparison (uses 15-min cache)
            let globalRankMap = null;
            let alignmentStats = null;

            if (window.firebaseAPI?.getGlobalRankings && state.matches.length >= 5) {
                try {
                    const globalData = await window.firebaseAPI.getGlobalRankings(images);
                    if (globalData && !globalData.error) {
                        // Build rank lookup map (shuffle for random tie order)
                        const globalSorted = shuffleArray(images)
                            .map(img => ({ id: img.id, elo: globalData.ratings[img.id] || 1500 }))
                            .sort((a, b) => b.elo - a.elo);

                        globalRankMap = {};
                        globalSorted.forEach((img, idx) => {
                            globalRankMap[img.id] = idx + 1;
                        });

                        // Calculate alignment stats
                        alignmentStats = calculateAlignment(sorted, globalSorted, globalData);
                    }
                } catch (e) {
                    console.warn('Failed to fetch global comparison:', e);
                }
            }

            // Show alignment summary if available (and user has voted enough)
            if (alignmentStats && state.matches.length >= 10) {
                const summaryDiv = document.createElement('div');
                summaryDiv.className = 'alignment-summary';
                summaryDiv.innerHTML = `
                    <span class="alignment-score">${alignmentStats.overlap}% match</span>
                    <span class="alignment-detail">with community taste</span>
                `;
                container.appendChild(summaryDiv);
            }

            renderRankingsGrid(container, sorted, state.matches.length, globalRankMap);
        }

        function calculateAlignment(localSorted, globalSorted, globalData) {
            const localTop20 = localSorted.slice(0, 20).map(i => i.id);
            const globalTop20 = globalSorted.slice(0, 20).map(i => i.id);
            const overlap = localTop20.filter(id => globalTop20.includes(id)).length;

            return {
                overlap: Math.round((overlap / 20) * 100),
                yourTop1GlobalRank: globalSorted.findIndex(g => g.id === localSorted[0]?.id) + 1,
                totalVoters: globalData.uniqueVoters,
                totalVotes: globalData.totalVotes
            };
        }

        async function renderGlobalLeaderboard(container) {
            // Show loading state
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'global-loading';
            loadingDiv.innerHTML = `
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"/>
                    <path d="M12 6v6l4 2"/>
                </svg>
                <div>Loading community rankings...</div>
            `;
            container.appendChild(loadingDiv);

            // Check if Firebase is ready
            if (!window.firebaseAPI?.getGlobalRankings) {
                loadingDiv.innerHTML = '<div>Global rankings require Firebase connection</div>';
                return;
            }

            try {
                const globalData = await window.firebaseAPI.getGlobalRankings(images);

                if (!globalData || globalData.error) {
                    const errorMsg = globalData?.message || 'Unknown error';
                    console.error('Global rankings error:', errorMsg);
                    loadingDiv.innerHTML = `<div>Unable to load global rankings.<br><small style="opacity:0.7">${escapeHtml(errorMsg)}</small></div>`;
                    return;
                }

                // Remove loading
                loadingDiv.remove();

                // Show stats
                const statsDiv = document.createElement('div');
                statsDiv.className = 'global-stats';
                statsDiv.innerHTML = `<strong>${globalData.totalVotes.toLocaleString()}</strong> votes from <strong>${globalData.uniqueVoters.toLocaleString()}</strong> participants`;
                container.appendChild(statsDiv);

                // Build sorted array (shuffle first for random tie order)
                const sorted = shuffleArray(images)
                    .map(img => ({
                        ...img,
                        elo: globalData.ratings[img.id] || DEFAULT_ELO,
                        wins: globalData.stats[img.id]?.wins || 0,
                        losses: globalData.stats[img.id]?.losses || 0
                    }))
                    .sort((a, b) => b.elo - a.elo);

                renderRankingsGrid(container, sorted, globalData.totalVotes);
            } catch (e) {
                console.error('Failed to render global leaderboard:', e);
                loadingDiv.innerHTML = '<div>Error loading rankings. Please try again.</div>';
            }
        }

        function renderRankingsGrid(container, sorted, totalVotes, globalRankMap = null) {
            // Create gallery grid
            const grid = document.createElement('div');
            grid.className = 'rankings-grid';

            sorted.forEach((img, i) => {
                const card = document.createElement('div');
                const localRank = i + 1;

                // Badge styling for top 3
                let badgeClass = 'rank-badge';
                let cardClass = 'rank-card';
                if (i === 0) { badgeClass += ' gold'; cardClass += ' top-gold'; }
                else if (i === 1) { badgeClass += ' silver'; cardClass += ' top-silver'; }
                else if (i === 2) { badgeClass += ' bronze'; cardClass += ' top-bronze'; }

                card.className = cardClass;

                // Comparison badge (your rank vs global rank)
                let comparisonHtml = '';
                if (globalRankMap && globalRankMap[img.id]) {
                    const globalRank = globalRankMap[img.id];
                    const diff = globalRank - localRank;
                    let diffLabel = '';
                    let diffClass = '';
                    let explanation = '';
                    if (diff > 0) {
                        diffLabel = `${diff}`;
                        diffClass = 'higher';
                        explanation = `You rank this ${diff} higher than community (#${localRank} vs #${globalRank})`;
                    } else if (diff < 0) {
                        diffLabel = `${Math.abs(diff)}`;
                        diffClass = 'lower';
                        explanation = `You rank this ${Math.abs(diff)} lower than community (#${localRank} vs #${globalRank})`;
                    } else {
                        diffLabel = '=';
                        diffClass = 'same';
                        explanation = `Same as community (#${globalRank})`;
                    }
                    comparisonHtml = `<div class="rank-comparison ${diffClass}" title="${explanation}">${diffLabel}</div>`;
                }

                const altText = img.description ? `${img.name}: ${img.description}` : img.name;
                card.innerHTML = `
                    <button class="rank-card-link" data-src="${escapeHtml(img.src)}" data-name="${escapeHtml(img.name)}" data-id="${escapeHtml(img.id)}" data-rank="${localRank}" title="${escapeHtml(img.description || img.name)}" aria-label="View ${escapeHtml(img.name)} full size">
                        <img src="${escapeHtml(img.src)}" alt="${escapeHtml(altText)}" loading="lazy" decoding="async" width="1408" height="768">
                    </button>
                    <button class="rank-action rank-action--share"
                            data-id="${escapeHtml(img.id)}"
                            data-rank="${localRank}"
                            data-name="${escapeHtml(img.name)}"
                            data-src="${escapeHtml(img.src)}"
                            aria-label="Share image" title="Share">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M4 12v8a2 2 0 002 2h12a2 2 0 002-2v-8M16 6l-4-4-4 4M12 2v13"/>
                        </svg>
                    </button>
                    ${comparisonHtml}
                    <div class="${badgeClass}">#${i + 1}</div>
                    <div class="rank-card-footer">
                        <div class="rank-card-title">${escapeHtml(img.name)}</div>
                        <span class="rank-card-elo">${img.elo}</span>
                    </div>
                `;
                grid.appendChild(card);
            });

            container.appendChild(grid);
        }

        // Share rankings via Web Share API or clipboard
        async function shareRankings() {
            const sorted = images
                .map(img => ({ name: img.name, elo: state.ratings[img.id] || DEFAULT_ELO }))
                .sort((a, b) => b.elo - a.elo)
                .slice(0, 5);

            const top5Text = sorted.map((img, i) => `${i + 1}. ${img.name}`).join('\n');
            const shareText = `My Christmas Stories Top 5:\n${top5Text}`;
            const shareUrl = window.location.href.split('#')[0];

            const shareData = {
                title: 'My Christmas Stories Rankings',
                text: shareText,
                url: shareUrl
            };

            try {
                if (navigator.share && navigator.canShare && navigator.canShare(shareData)) {
                    await navigator.share(shareData);
                    announce('Shared!');
                } else {
                    await navigator.clipboard.writeText(`${shareText}\n\n${shareUrl}`);
                    announce('Rankings copied to clipboard!');
                }
            } catch (e) {
                if (e.name !== 'AbortError') {
                    try {
                        await navigator.clipboard.writeText(`${shareText}\n\n${shareUrl}`);
                        announce('Rankings copied to clipboard!');
                    } catch (clipErr) {
                        announce('Unable to share');
                    }
                }
            }
        }

        function exportData() {
            const data = {
                exported: new Date().toISOString(),
                totalVotes: state.matches.length,
                rankings: images
                    .map(img => ({
                        id: img.id,
                        name: img.name,
                        elo: state.ratings[img.id] || DEFAULT_ELO,
                        wins: state.matches.filter(m => m.winner === img.id).length,
                        losses: state.matches.filter(m => m.loser === img.id).length
                    }))
                    .sort((a, b) => b.elo - a.elo),
                matches: state.matches
            };

            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `bear-rankings-${Date.now()}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            announce('Rankings exported');
        }

        function resetData() {
            if (confirm('Reset all rankings and votes? This cannot be undone.')) {
                try {
                    localStorage.removeItem(STORAGE_KEY);
                } catch (e) {
                    console.error('Failed to clear storage:', e);
                }
                state.ratings = {};
                state.matches = [];
                loadState();
                updateStats();
                showPair();
                renderLeaderboard();
                announce('Rankings reset');
            }
        }

        // ============================================
        // EVENT HANDLERS
        // ============================================
        function handleCardClick(side) {
            const card = document.getElementById(side === 'left' ? 'cardLeft' : 'cardRight');
            card.classList.add('selected');

            setTimeout(() => {
                card.classList.remove('selected');
                vote(side);
            }, 150);
        }

        document.getElementById('cardLeft').addEventListener('click', () => handleCardClick('left'));
        document.getElementById('cardRight').addEventListener('click', () => handleCardClick('right'));

        // Keyboard navigation
        document.addEventListener('keydown', (e) => {
            // Don't capture if user is in an input
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;

            const arenaVisible = !document.querySelector('.arena-view').classList.contains('hidden');
            if (!arenaVisible) return;

            switch (e.key) {
                case 'ArrowLeft':
                case 'a':
                case 'A':
                case '1':
                    e.preventDefault();
                    handleCardClick('left');
                    break;
                case 'ArrowRight':
                case 'd':
                case 'D':
                case '2':
                    e.preventDefault();
                    handleCardClick('right');
                    break;
                case 's':
                case 'S':
                case 'ArrowDown':
                    e.preventDefault();
                    showPair();
                    announce('Skipped');
                    break;
            }
        });

        // Touch/swipe support
        let touchStartY = 0;
        let touchStartTime = 0;

        document.addEventListener('touchstart', (e) => {
            touchStartY = e.touches[0].clientY;
            touchStartTime = Date.now();
        }, { passive: true });

        document.addEventListener('touchend', (e) => {
            const deltaY = e.changedTouches[0].clientY - touchStartY;
            const deltaTime = Date.now() - touchStartTime;

            // Quick swipe down to skip (within 300ms, > 80px)
            if (deltaTime < 300 && deltaY > 80) {
                const arenaVisible = !document.querySelector('.arena-view').classList.contains('hidden');
                if (arenaVisible) {
                    showPair();
                    announce('Skipped');
                }
            }
        }, { passive: true });

        // Tab switching with proper ARIA
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                // Update ARIA states
                document.querySelectorAll('.tab').forEach(t => {
                    t.classList.remove('active');
                    t.setAttribute('aria-selected', 'false');
                    t.setAttribute('tabindex', '-1');
                });
                tab.classList.add('active');
                tab.setAttribute('aria-selected', 'true');
                tab.setAttribute('tabindex', '0');

                const view = tab.dataset.view;
                const arenaView = document.querySelector('.arena-view');
                const leaderboard = document.getElementById('leaderboard-panel');

                arenaView.classList.toggle('hidden', view !== 'arena');
                leaderboard.classList.toggle('active', view === 'leaderboard');

                // Manage hidden attribute for accessibility
                document.getElementById('arena-panel').hidden = view !== 'arena';
                document.getElementById('leaderboard-panel').hidden = view !== 'leaderboard';

                if (view === 'leaderboard') {
                    renderLeaderboard();
                }
            });
        });

        // Tab keyboard navigation (arrow keys)
        const tabList = document.querySelector('[role="tablist"]');
        const tabButtons = tabList.querySelectorAll('[role="tab"]');

        tabList.addEventListener('keydown', (e) => {
            const currentIndex = Array.from(tabButtons).indexOf(document.activeElement);
            let newIndex;
            switch (e.key) {
                case 'ArrowLeft':
                case 'ArrowUp':
                    newIndex = currentIndex === 0 ? tabButtons.length - 1 : currentIndex - 1;
                    break;
                case 'ArrowRight':
                case 'ArrowDown':
                    newIndex = currentIndex === tabButtons.length - 1 ? 0 : currentIndex + 1;
                    break;
                default:
                    return;
            }
            e.preventDefault();
            tabButtons.forEach(t => t.setAttribute('tabindex', '-1'));
            tabButtons[newIndex].setAttribute('tabindex', '0');
            tabButtons[newIndex].focus();
            tabButtons[newIndex].click();
        });


        // ============================================
        // SUGGESTIONS SYSTEM
        // ============================================
        const SUGGESTION_STORAGE_KEY = 'bearSuggestions_v1';

        let suggestions = [];

        function isValidSuggestionsData(data) {
            if (!Array.isArray(data)) return false;
            for (const item of data) {
                if (!item || typeof item !== 'object') return false;
                if (typeof item.text !== 'string') return false;
                if (typeof item.timestamp !== 'number' || isNaN(item.timestamp)) return false;
            }
            return true;
        }

        function loadSuggestions() {
            try {
                const suggestionsRaw = localStorage.getItem(SUGGESTION_STORAGE_KEY);
                if (suggestionsRaw) {
                    const parsed = JSON.parse(suggestionsRaw);
                    if (isValidSuggestionsData(parsed)) {
                        suggestions = parsed;
                    } else {
                        suggestions = [];
                        localStorage.removeItem(SUGGESTION_STORAGE_KEY);
                    }
                }
            } catch (e) {
                suggestions = [];
                try {
                    localStorage.removeItem(SUGGESTION_STORAGE_KEY);
                } catch (removeErr) {}
            }
        }

        function saveSuggestions() {
            try {
                localStorage.setItem(SUGGESTION_STORAGE_KEY, JSON.stringify(suggestions));
            } catch (e) {
                console.warn('Failed to save suggestions:', e);
            }
        }

        // Vote function with feedback, undo, and Firebase sync
        function vote(winner) {
            if (!state.currentPair) return;

            const winnerId = winner === 'left'
                ? state.currentPair.left.id
                : state.currentPair.right.id;
            const loserId = winner === 'left'
                ? state.currentPair.right.id
                : state.currentPair.left.id;
            const winnerName = winner === 'left'
                ? state.currentPair.left.name
                : state.currentPair.right.name;

            updateRatings(winnerId, loserId);
            updateStats();

            // Send to Firebase (fire and forget - doesn't block UI)
            if (window.firebaseAPI?.isReady()) {
                window.firebaseAPI.submitVote(winnerId, loserId);
            }

            showPair();
        }

        // Export data function
        exportData = function() {
            const data = {
                exported: new Date().toISOString(),
                totalVotes: state.matches.length,
                rankings: images
                    .map(img => ({
                        id: img.id,
                        name: img.name,
                        elo: state.ratings[img.id] || DEFAULT_ELO,
                        wins: state.matches.filter(m => m.winner === img.id).length,
                        losses: state.matches.filter(m => m.loser === img.id).length
                    }))
                    .sort((a, b) => b.elo - a.elo),
                matches: state.matches,
                suggestions: suggestions
            };

            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `bear-rankings-${Date.now()}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            announce('Rankings exported');
        };

        function exportDataCSV() {
            const sorted = images
                .map(img => ({
                    id: img.id,
                    name: img.name,
                    elo: state.ratings[img.id] || DEFAULT_ELO,
                    wins: state.matches.filter(m => m.winner === img.id).length,
                    losses: state.matches.filter(m => m.loser === img.id).length
                }))
                .sort((a, b) => b.elo - a.elo);

            const csvHeader = 'rank,filename,name,elo,wins,losses\n';
            const csvRows = sorted.map((img, i) =>
                `${i + 1},"${img.id}","${img.name.replace(/"/g, '""')}",${Math.round(img.elo)},${img.wins},${img.losses}`
            ).join('\n');

            const csv = csvHeader + csvRows;
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `christmas-stories-rankings-${new Date().toISOString().slice(0, 10)}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            announce('Rankings exported as CSV');
        }

        loadSuggestions();

        // ============================================
        // INIT
        // ============================================
        loadState();
        updateStats();
        showPair();

        // ============================================
        // SHARE FUNCTIONALITY (V2)
        // ============================================
        const SHARE_PLATFORMS = {
            facebook: (url) =>
                `https://facebook.com/sharer/sharer.php?u=${encodeURIComponent(url)}`,
            instagram: (url, text) =>
                `https://www.instagram.com/`,  // Instagram doesn't support direct URL sharing - opens app
            pinterest: (url, imgUrl, desc) =>
                `https://pinterest.com/pin/create/button/?url=${encodeURIComponent(url)}&media=${encodeURIComponent(imgUrl)}&description=${encodeURIComponent(desc)}`,
            whatsapp: (url, text) =>
                `https://api.whatsapp.com/send?text=${encodeURIComponent(text + ' ' + url)}`,
            signal: (url, text) =>
                `https://signal.me/#p/${encodeURIComponent(text + ' ' + url)}`,  // Signal share via URL scheme
        };

        async function shareImage(imageId, rank, imageSrc, imageName) {
            const baseUrl = location.href.split('?')[0].split('#')[0];
            const shareUrl = `${baseUrl}#image=${encodeURIComponent(imageId)}`;
            const shareText = `My #${rank} pick: ${imageName}`;

            // Try Web Share API first (mobile)
            if (navigator.share) {
                try {
                    await navigator.share({
                        title: 'Christmas Stories',
                        text: shareText,
                        url: shareUrl
                    });
                    announce('Shared!');
                    return;
                } catch (e) {
                    if (e.name === 'AbortError') return; // User cancelled
                    // Fall through to menu
                }
            }

            // Desktop fallback: show share menu
            showShareMenu(shareUrl, shareText, imageSrc, imageName, rank);
        }

        function showShareMenu(url, text, imgSrc, imgName, rank) {
            const menu = document.getElementById('shareMenu');
            document.getElementById('sharePreviewImg').src = imgSrc;
            document.getElementById('sharePreviewText').textContent = `#${rank}: ${imgName}`;

            // Set up platform buttons
            menu.querySelectorAll('.share-option').forEach(btn => {
                btn.onclick = async () => {
                    const platform = btn.dataset.platform;
                    if (platform === 'copy') {
                        await navigator.clipboard.writeText(url);
                        announce('Link copied!');
                        menu.close();
                    } else if (platform === 'pinterest') {
                        const fullImgUrl = new URL(imgSrc, location.href).href;
                        window.open(SHARE_PLATFORMS.pinterest(url, fullImgUrl, text), '_blank', 'width=600,height=400');
                        menu.close();
                    } else {
                        window.open(SHARE_PLATFORMS[platform](url, text), '_blank', 'width=600,height=400');
                        menu.close();
                    }
                };
            });

            menu.showModal();
        }

        // Share menu close handlers
        document.getElementById('shareMenuClose').addEventListener('click', () => {
            document.getElementById('shareMenu').close();
        });
        document.getElementById('shareMenu').addEventListener('click', (e) => {
            if (e.target.id === 'shareMenu') {
                document.getElementById('shareMenu').close();
            }
        });

        // Delegate click on share buttons in rankings
        document.getElementById('leaderboard-panel').addEventListener('click', (e) => {
            const shareBtn = e.target.closest('.rank-action--share');
            if (shareBtn) {
                e.preventDefault();
                e.stopPropagation();
                shareImage(
                    shareBtn.dataset.id,
                    shareBtn.dataset.rank,
                    shareBtn.dataset.src,
                    shareBtn.dataset.name
                );
            }
        });

        // ============================================
        // LIGHTBOX (Image Viewer)
        // ============================================
        const lightbox = document.getElementById('imageLightbox');
        const lightboxImg = document.getElementById('lightboxImg');
        const lightboxDownload = document.getElementById('lightboxDownload');
        const lightboxShare = document.getElementById('lightboxShare');
        const lightboxClose = document.getElementById('lightboxClose');
        let currentLightboxData = { src: '', name: '', id: '', rank: null };

        function openLightbox(src, name, id, rank = null) {
            currentLightboxData = { src, name, id, rank };
            lightboxImg.src = src;
            lightboxImg.alt = name;
            lightboxDownload.href = src;
            lightboxDownload.download = id + '.png';
            lightbox.showModal();
        }

        function closeLightbox() {
            lightboxImg.classList.remove('zoomed', 'panning');
            lightboxImg.style.transformOrigin = 'center center';
            lightbox.close();
        }

        // Zoom on double-click/tap
        lightboxImg.addEventListener('dblclick', (e) => {
            if (lightboxImg.classList.contains('zoomed')) {
                lightboxImg.classList.remove('zoomed', 'panning');
                lightboxImg.style.transformOrigin = 'center center';
            } else {
                // Zoom to click point
                const rect = lightboxImg.getBoundingClientRect();
                const x = ((e.clientX - rect.left) / rect.width) * 100;
                const y = ((e.clientY - rect.top) / rect.height) * 100;
                lightboxImg.style.transformOrigin = `${x}% ${y}%`;
                lightboxImg.classList.add('zoomed');
            }
        });

        // Single click toggles zoom (mobile-friendly)
        lightboxImg.addEventListener('click', (e) => {
            // Ignore if it was a double-click
            if (e.detail === 2) return;

            setTimeout(() => {
                if (lightboxImg.classList.contains('zoomed')) {
                    lightboxImg.classList.remove('zoomed', 'panning');
                    lightboxImg.style.transformOrigin = 'center center';
                } else {
                    const rect = lightboxImg.getBoundingClientRect();
                    const x = ((e.clientX - rect.left) / rect.width) * 100;
                    const y = ((e.clientY - rect.top) / rect.height) * 100;
                    lightboxImg.style.transformOrigin = `${x}% ${y}%`;
                    lightboxImg.classList.add('zoomed');
                }
            }, 200);
        });

        // Share button handler - use same shareImage function as rankings
        lightboxShare.addEventListener('click', async () => {
            const { src, name, id, rank } = currentLightboxData;
            // Use rank if available, otherwise show without rank prefix
            shareImage(id, rank || '?', src, name);
        });

        // Lightbox close handlers
        lightboxClose.addEventListener('click', closeLightbox);
        lightbox.addEventListener('click', (e) => {
            if (e.target === lightbox) closeLightbox();
        });

        // Delegate click on rankings to open lightbox
        document.getElementById('leaderboard-panel').addEventListener('click', (e) => {
            const viewBtn = e.target.closest('.rank-card-link');
            if (viewBtn && viewBtn.dataset.src) {
                e.preventDefault();
                openLightbox(viewBtn.dataset.src, viewBtn.dataset.name, viewBtn.dataset.id, viewBtn.dataset.rank);
            }
        });

        // ============================================
        // IMAGINE BAR (opens Elf dialog)
        // ============================================
        document.getElementById('imagineBar').addEventListener('click', () => {
            document.getElementById('helpDialog').showModal();
        });

        // ============================================
        // THEME TOGGLE
        // ============================================
        const THEME_STORAGE_KEY = 'nutcracker_theme';
        const themeToggle = document.getElementById('themeToggle');
        const themeColorMeta = document.getElementById('themeColor');

        function getCurrentTheme() {
            const stored = localStorage.getItem(THEME_STORAGE_KEY);
            if (stored) return stored;
            return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
        }

        function updateThemeUI(theme) {
            // Update aria-label based on current theme
            const newLabel = theme === 'dark' ? 'Switch to light mode' : 'Switch to dark mode';
            themeToggle.setAttribute('aria-label', newLabel);

            // Update theme-color meta tag for browser chrome
            themeColorMeta.setAttribute('content', theme === 'dark' ? '#1a1a2e' : '#f5f5f7');
        }

        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme') || getCurrentTheme();
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';

            // Apply theme
            document.documentElement.setAttribute('data-theme', newTheme);

            // Store preference
            try {
                localStorage.setItem(THEME_STORAGE_KEY, newTheme);
            } catch (e) {
                console.warn('Failed to save theme preference:', e);
            }

            // Update UI
            updateThemeUI(newTheme);

            // Announce for screen readers
            announce(`Switched to ${newTheme} mode`);
        }

        // Initialize theme UI state
        updateThemeUI(getCurrentTheme());

        // Theme toggle click handler
        themeToggle.addEventListener('click', toggleTheme);

        // Listen for system theme changes (only when no stored preference)
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
            if (!localStorage.getItem(THEME_STORAGE_KEY)) {
                const newTheme = e.matches ? 'dark' : 'light';
                document.documentElement.setAttribute('data-theme', newTheme);
                updateThemeUI(newTheme);
            }
        });

        // ============================================
        // SERVICE WORKER REGISTRATION (PWA Support)
        // ============================================
        if ('serviceWorker' in navigator) {
            // Only register SW when served over HTTP(S), not file://
            if (window.location.protocol.startsWith('http')) {
                window.addEventListener('load', () => {
                    navigator.serviceWorker.register('./sw.js')
                        .then((registration) => {
                            console.log('[PWA] Service Worker registered:', registration.scope);

                            // Check for updates periodically
                            registration.addEventListener('updatefound', () => {
                                const newWorker = registration.installing;
                                console.log('[PWA] New service worker installing...');

                                newWorker.addEventListener('statechange', () => {
                                    if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                        // New content available
                                        console.log('[PWA] New content available, refresh to update');
                                    }
                                });
                            });
                        })
                        .catch((error) => {
                            console.warn('[PWA] Service Worker registration failed:', error);
                        });
                });
            } else {
                console.log('[PWA] Service Worker not available in file:// protocol');
            }
        }

        // ============================================
        // HELP DIALOG - Client-Side FAQ Matcher
        // ============================================
        (function() {
            'use strict';

            // DOM Elements
            const helpBtn = document.getElementById('helpBtn');
            const helpDialog = document.getElementById('helpDialog');
            const helpClose = document.getElementById('helpClose');
            const helpForm = document.getElementById('helpForm');
            const helpInput = document.getElementById('helpInput');
            const helpMessages = document.getElementById('helpMessages');

            // ============================================
            // FAQ DATA & FUSE.JS INDEX
            // ============================================
            let faqData = [];
            let exactMatchMap = new Map();
            let fuseInstance = null;
            let configLoaded = false;

            // Load FAQ config on page load
            async function loadFaqConfig() {
                try {
                    const response = await fetch('/chatbot-config.json');
                    if (!response.ok) throw new Error('Failed to load FAQ config');
                    const config = await response.json();

                    // Flatten FAQ categories into single array
                    faqData = [];
                    config.faq.forEach(category => {
                        category.questions.forEach(qa => {
                            faqData.push({
                                q: qa.q,
                                a: qa.a,
                                category: category.category,
                                qLower: qa.q.toLowerCase()
                            });
                        });
                    });

                    // Build exact match hash map
                    exactMatchMap = new Map();
                    faqData.forEach((faq, idx) => {
                        exactMatchMap.set(faq.qLower, idx);
                    });

                    // Initialize Fuse.js for fuzzy matching
                    fuseInstance = new Fuse(faqData, {
                        keys: ['q', 'a'],
                        includeScore: true,
                        threshold: 0.4,
                        ignoreLocation: true,
                        minMatchCharLength: 3
                    });

                    configLoaded = true;
                    console.log('[Help] FAQ config loaded:', faqData.length, 'entries');
                } catch (error) {
                    console.error('[Help] Failed to load FAQ config:', error);
                    // Continue with degraded mode - will fall back to LLM
                }
            }

            // Load config immediately
            loadFaqConfig();

            // ============================================
            // LAYER 1: PREPROCESSING
            // ============================================
            const CONTRACTIONS = {
                "can't": "cannot", "won't": "will not", "don't": "do not",
                "doesn't": "does not", "didn't": "did not", "isn't": "is not",
                "aren't": "are not", "wasn't": "was not", "weren't": "were not",
                "haven't": "have not", "hasn't": "has not", "hadn't": "had not",
                "couldn't": "could not", "wouldn't": "would not", "shouldn't": "should not",
                "i'm": "i am", "you're": "you are", "we're": "we are", "they're": "they are",
                "it's": "it is", "that's": "that is", "what's": "what is", "who's": "who is",
                "where's": "where is", "how's": "how is", "there's": "there is",
                "i've": "i have", "you've": "you have", "we've": "we have", "they've": "they have",
                "i'll": "i will", "you'll": "you will", "we'll": "we will", "they'll": "they will",
                "i'd": "i would", "you'd": "you would", "we'd": "we would", "they'd": "they would"
            };

            const FILLER_WORDS = new Set([
                'um', 'uh', 'like', 'just', 'please', 'thanks', 'thank', 'hey', 'hi', 'hello',
                'yo', 'well', 'so', 'okay', 'ok', 'right', 'actually', 'basically', 'literally'
            ]);

            function preprocess(input) {
                let text = input.toLowerCase().trim();

                // Expand contractions
                Object.entries(CONTRACTIONS).forEach(([contraction, expansion]) => {
                    text = text.replace(new RegExp(contraction.replace(/'/g, "'?"), 'gi'), expansion);
                });

                // Remove punctuation except ?
                text = text.replace(/[^\w\s?]/g, ' ');

                // Remove filler words
                const words = text.split(/\s+/).filter(w => !FILLER_WORDS.has(w) && w.length > 0);

                return words.join(' ').trim();
            }

            // ============================================
            // LAYER 2: TYPO CORRECTION
            // ============================================
            const TYPO_MAP = {
                'teh': 'the', 'voet': 'vote', 'votin': 'voting', 'votign': 'voting',
                'ranknig': 'ranking', 'rankign': 'ranking', 'iamge': 'image', 'imge': 'image',
                'exprot': 'export', 'exoprt': 'export', 'donwload': 'download',
                'keyboad': 'keyboard', 'keybaord': 'keyboard', 'keyborad': 'keyboard',
                'installl': 'install', 'instal': 'install', 'pwa': 'pwa',
                'offlien': 'offline', 'ofline': 'offline', 'offiline': 'offline',
                'theem': 'theme', 'themse': 'themes', 'daark': 'dark', 'ligth': 'light',
                'undoo': 'undo', 'ubndo': 'undo', 'unod': 'undo',
                'priavcy': 'privacy', 'privcy': 'privacy', 'pirracy': 'privacy',
                'accesibility': 'accessibility', 'accessiblity': 'accessibility',
                'screne': 'screen', 'scren': 'screen', 'broswer': 'browser',
                'howt': 'how to', 'waht': 'what', 'whta': 'what', 'wehre': 'where',
                'cna': 'can', 'nad': 'and', 'adn': 'and', 'thr': 'the', 'fo': 'of'
            };

            const VOCABULARY = [
                'vote', 'voting', 'rank', 'ranking', 'rankings', 'elo', 'export',
                'undo', 'theme', 'dark', 'light', 'install', 'pwa', 'offline',
                'image', 'images', 'keyboard', 'shortcut', 'browser', 'data',
                'privacy', 'anonymous', 'reset', 'clear', 'bug', 'error', 'broken',
                'problem', 'issue', 'help', 'how', 'what', 'why', 'can', 'where',
                'download', 'save', 'backup', 'share', 'accessibility', 'screen',
                'reader', 'contrast', 'motion', 'firebase', 'sync', 'global', 'local'
            ];

            function levenshtein(a, b) {
                const matrix = Array(b.length + 1).fill(null).map(() =>
                    Array(a.length + 1).fill(null)
                );
                for (let i = 0; i <= a.length; i++) matrix[0][i] = i;
                for (let j = 0; j <= b.length; j++) matrix[j][0] = j;
                for (let j = 1; j <= b.length; j++) {
                    for (let i = 1; i <= a.length; i++) {
                        const indicator = a[i - 1] === b[j - 1] ? 0 : 1;
                        matrix[j][i] = Math.min(
                            matrix[j][i - 1] + 1,
                            matrix[j - 1][i] + 1,
                            matrix[j - 1][i - 1] + indicator
                        );
                    }
                }
                return matrix[b.length][a.length];
            }

            function correctTypos(text) {
                const words = text.split(/\s+/);
                return words.map(word => {
                    // Check explicit typo map first
                    if (TYPO_MAP[word]) return TYPO_MAP[word];

                    // Only try to correct if word isn't already valid
                    if (VOCABULARY.includes(word)) return word;

                    // Try Levenshtein for short words (likely typos)
                    if (word.length >= 3 && word.length <= 12) {
                        let bestMatch = word;
                        let bestDist = 2; // Only correct if distance <= 2

                        for (const vocabWord of VOCABULARY) {
                            if (Math.abs(vocabWord.length - word.length) > 2) continue;
                            const dist = levenshtein(word, vocabWord);
                            if (dist < bestDist) {
                                bestDist = dist;
                                bestMatch = vocabWord;
                            }
                        }
                        return bestMatch;
                    }
                    return word;
                }).join(' ');
            }

            // ============================================
            // LAYER 3: INTENT EXTRACTION
            // ============================================
            const ACTION_KEYWORDS = {
                vote: ['vote', 'voting', 'choose', 'pick', 'select', 'click', 'tap', 'compare'],
                view_rankings: ['ranking', 'rankings', 'leaderboard', 'scores', 'ratings', 'top', 'best', 'winner', 'see', 'view', 'show'],
                export: ['export', 'download', 'save', 'backup', 'json', 'file'],
                undo: ['undo', 'reverse', 'mistake', 'wrong', 'accident', 'back', 'cancel'],
                theme: ['theme', 'dark', 'light', 'mode', 'color', 'appearance', 'toggle'],
                install: ['install', 'pwa', 'app', 'offline', 'home screen', 'add'],
                reset: ['reset', 'clear', 'delete', 'start over', 'fresh', 'erase'],
                report_bug: ['bug', 'error', 'broken', 'issue', 'problem', 'not working', 'crash', 'glitch', 'fail'],
                feedback: ['suggest', 'suggestion', 'idea', 'wish', 'want', 'would be nice', 'feature', 'improve'],
                keyboard: ['keyboard', 'shortcut', 'key', 'arrow', 'hotkey'],
                privacy: ['privacy', 'data', 'anonymous', 'personal', 'information', 'stored', 'firebase']
            };

            const OBJECT_KEYWORDS = {
                image: ['image', 'images', 'picture', 'pictures', 'photo', 'photos', 'artwork', 'bear', 'whale'],
                ranking: ['ranking', 'rankings', 'leaderboard', 'score', 'scores', 'elo', 'rating', 'ratings'],
                data: ['data', 'storage', 'local', 'firebase', 'cloud', 'sync', 'export'],
                keyboard: ['keyboard', 'key', 'keys', 'shortcut', 'shortcuts', 'arrow'],
                browser: ['browser', 'chrome', 'firefox', 'safari', 'edge'],
                device: ['device', 'phone', 'mobile', 'desktop', 'tablet', 'iphone', 'android', 'ipad']
            };

            const FRUSTRATED_PATTERNS = [
                'not working', 'broken', 'crash', 'error', 'fail', 'stuck',
                'annoying', 'frustrating', 'hate', 'terrible', 'worst', 'useless',
                'cannot', 'can not', 'unable', 'impossible', "doesn't work", "won't work"
            ];

            const CONFUSED_PATTERNS = [
                'confused', 'confusing', 'understand', 'unclear', 'lost',
                'where is', 'how do i', 'what does', 'no idea', 'help me'
            ];

            function extractIntent(text) {
                const textLower = text.toLowerCase();

                // Detect question type
                let questionType = null;
                if (textLower.startsWith('how')) questionType = 'how';
                else if (textLower.startsWith('what')) questionType = 'what';
                else if (textLower.startsWith('why')) questionType = 'why';
                else if (textLower.startsWith('can')) questionType = 'can';
                else if (textLower.startsWith('is')) questionType = 'is';
                else if (textLower.startsWith('where')) questionType = 'where';
                else if (textLower.includes('?')) questionType = 'question';

                // Detect actions
                const actions = [];
                for (const [action, keywords] of Object.entries(ACTION_KEYWORDS)) {
                    if (keywords.some(kw => textLower.includes(kw))) {
                        actions.push(action);
                    }
                }

                // Detect objects
                const objects = [];
                for (const [object, keywords] of Object.entries(OBJECT_KEYWORDS)) {
                    if (keywords.some(kw => textLower.includes(kw))) {
                        objects.push(object);
                    }
                }

                // Detect sentiment
                let sentiment = 'neutral';
                if (FRUSTRATED_PATTERNS.some(p => textLower.includes(p))) {
                    sentiment = 'frustrated';
                } else if (CONFUSED_PATTERNS.some(p => textLower.includes(p))) {
                    sentiment = 'confused';
                } else if (textLower.includes('love') || textLower.includes('great') || textLower.includes('awesome')) {
                    sentiment = 'positive';
                }

                // Confidence based on specificity
                let confidence = 0.5;
                if (actions.length > 0) confidence += 0.2;
                if (objects.length > 0) confidence += 0.15;
                if (questionType) confidence += 0.1;
                confidence = Math.min(confidence, 1.0);

                return { questionType, actions, objects, sentiment, confidence };
            }

            // ============================================
            // LAYER 4: MULTI-STRATEGY MATCHING
            // ============================================
            function matchFaq(rawInput) {
                if (!configLoaded || faqData.length === 0) {
                    return { score: 0, faq: null, strategy: 'none', intent: null };
                }

                // Preprocess and correct
                const preprocessed = preprocess(rawInput);
                const corrected = correctTypos(preprocessed);
                const intent = extractIntent(corrected);

                // Strategy 1: Exact match (hash lookup)
                const exactIdx = exactMatchMap.get(corrected);
                if (exactIdx !== undefined) {
                    return { score: 1.0, faq: faqData[exactIdx], strategy: 'exact', intent };
                }

                // Also check raw preprocessed without typo correction
                const exactRawIdx = exactMatchMap.get(preprocessed);
                if (exactRawIdx !== undefined) {
                    return { score: 1.0, faq: faqData[exactRawIdx], strategy: 'exact', intent };
                }

                // Strategy 2: Action-based matching
                if (intent.actions.length > 0) {
                    const actionMatches = findActionMatches(intent.actions, intent.objects);
                    if (actionMatches.length > 0 && actionMatches[0].score >= 0.75) {
                        return { score: actionMatches[0].score, faq: actionMatches[0].faq, strategy: 'action', intent, alternatives: actionMatches.slice(1) };
                    }
                }

                // Strategy 3: Fuzzy match via Fuse.js
                const fuseResults = fuseInstance.search(corrected);
                if (fuseResults.length > 0) {
                    // Fuse score is 0 = perfect, 1 = no match; invert it
                    const fuseScore = 1 - fuseResults[0].score;
                    if (fuseScore >= 0.5) {
                        const alternatives = fuseResults.slice(1, 4).map(r => ({
                            faq: r.item,
                            score: 1 - r.score
                        }));
                        return { score: fuseScore, faq: fuseResults[0].item, strategy: 'fuzzy', intent, alternatives };
                    }
                }

                // Strategy 4: Keyword frequency
                const keywordMatch = findKeywordMatch(corrected);
                if (keywordMatch.score >= 0.5) {
                    return { score: keywordMatch.score, faq: keywordMatch.faq, strategy: 'keyword', intent };
                }

                // No good match
                return { score: fuseResults.length > 0 ? (1 - fuseResults[0].score) : 0, faq: fuseResults[0]?.item || null, strategy: 'none', intent };
            }

            function findActionMatches(actions, objects) {
                const matches = [];

                // Map actions to likely FAQ categories/topics
                const actionFaqMap = {
                    vote: ['how does voting work', 'how are image pairs selected'],
                    view_rankings: ['how do i view rankings', 'what is the difference between my rankings and global rankings'],
                    export: ['how do i export my data'],
                    undo: ['can i undo a vote'],
                    theme: ['how does the theme toggle work'],
                    install: ['is this a pwa', 'why is the install prompt not appearing'],
                    reset: ['how do i reset my data'],
                    report_bug: ['how do i report a bug'],
                    keyboard: ['are keyboard shortcuts available'],
                    privacy: ['is my voting data stored', 'what data goes to firebase', 'is voting anonymous']
                };

                for (const action of actions) {
                    const relatedQuestions = actionFaqMap[action] || [];
                    for (const qPattern of relatedQuestions) {
                        const faq = faqData.find(f => f.qLower.includes(qPattern.toLowerCase()));
                        if (faq && !matches.find(m => m.faq === faq)) {
                            // Score based on action + object alignment
                            let score = 0.75;
                            if (objects.length > 0 && objects.some(obj =>
                                faq.qLower.includes(obj) || faq.a.toLowerCase().includes(obj)
                            )) {
                                score = 0.85;
                            }
                            matches.push({ faq, score });
                        }
                    }
                }

                return matches.sort((a, b) => b.score - a.score);
            }

            function findKeywordMatch(text) {
                const words = text.split(/\s+/).filter(w => w.length > 2);
                let bestMatch = { faq: null, score: 0 };

                for (const faq of faqData) {
                    const faqWords = faq.qLower.split(/\s+/).concat(faq.a.toLowerCase().split(/\s+/));
                    let matchCount = 0;

                    for (const word of words) {
                        if (faqWords.some(fw => fw.includes(word) || word.includes(fw))) {
                            matchCount++;
                        }
                    }

                    const score = words.length > 0 ? (matchCount / words.length) * 0.7 : 0;
                    if (score > bestMatch.score) {
                        bestMatch = { faq, score };
                    }
                }

                return bestMatch;
            }

            // ============================================
            // LAYER 5: CONFIDENCE ROUTING
            // ============================================
            const BUG_SIGNALS = ['broken', 'crash', 'error', 'not working', 'bug', 'glitch', 'fail', 'stuck', 'freeze'];
            const FEEDBACK_SIGNALS = ['wish', 'suggest', 'idea', 'would be nice', 'feature request', 'improve', 'add'];

            function routeByConfidence(matchResult, rawInput) {
                const inputLower = rawInput.toLowerCase();

                // Special case: Bug report signals override matching
                if (BUG_SIGNALS.some(signal => inputLower.includes(signal))) {
                    // But only if it seems like a report, not a question about bugs
                    if (!inputLower.startsWith('how') && !inputLower.includes('report a bug')) {
                        return { action: 'BUG_REPORT_FLOW', context: matchResult.intent };
                    }
                }

                // Special case: Feedback signals
                if (FEEDBACK_SIGNALS.some(signal => inputLower.includes(signal))) {
                    return { action: 'FEEDBACK_FLOW', context: matchResult.intent };
                }

                const { score, faq, alternatives, intent } = matchResult;

                // High confidence: Direct answer
                if (score >= 0.85 && faq) {
                    return { action: 'DIRECT_ANSWER', faq, context: intent };
                }

                // Medium-high confidence: Clarify
                if (score >= 0.60 && faq) {
                    return {
                        action: 'CLARIFY',
                        message: `Did you mean: "${faq.q}"?`,
                        faq,
                        alternatives: alternatives || [],
                        context: intent
                    };
                }

                // Medium confidence: Suggest related topics
                if (score >= 0.40 && faq) {
                    const suggestions = [faq];
                    if (alternatives) suggestions.push(...alternatives.slice(0, 2).map(a => a.faq));

                    return {
                        action: 'SUGGEST',
                        message: "I found some related topics that might help:",
                        suggestions,
                        context: intent
                    };
                }

                // Low confidence: Fall back to LLM
                return { action: 'LLM_FALLBACK', context: intent };
            }

            // ============================================
            // SYSTEM CONTEXT CAPTURE
            // ============================================
            function detectPlatform(ua) {
                if (/iPhone|iPad|iPod/.test(ua)) return 'iOS';
                if (/Android/.test(ua)) return 'Android';
                if (/Mac/.test(ua)) return 'macOS';
                if (/Win/.test(ua)) return 'Windows';
                if (/Linux/.test(ua)) return 'Linux';
                if (/CrOS/.test(ua)) return 'ChromeOS';
                return 'Unknown';
            }

            function detectOS(ua) {
                if (/iPhone|iPad|iPod/.test(ua)) return 'iOS';
                if (/Android/.test(ua)) return 'Android';
                if (/Mac OS X/.test(ua)) return 'macOS';
                if (/Windows NT 10/.test(ua)) return 'Windows 10/11';
                if (/Windows NT 6\.3/.test(ua)) return 'Windows 8.1';
                if (/Windows NT 6\.2/.test(ua)) return 'Windows 8';
                if (/Windows NT 6\.1/.test(ua)) return 'Windows 7';
                if (/Linux/.test(ua)) return 'Linux';
                if (/CrOS/.test(ua)) return 'ChromeOS';
                return 'Unknown';
            }

            function detectOSVersion(ua) {
                let match;
                if ((match = ua.match(/iPhone OS (\d+_\d+)/))) return match[1].replace('_', '.');
                if ((match = ua.match(/Android (\d+\.?\d*)/))) return match[1];
                if ((match = ua.match(/Mac OS X (\d+[._]\d+)/))) return match[1].replace('_', '.');
                if ((match = ua.match(/Windows NT (\d+\.\d+)/))) return match[1];
                return 'Unknown';
            }

            function detectBrowser(ua) {
                if (/Edg\//.test(ua)) return 'Edge';
                if (/Chrome\//.test(ua) && !/Chromium/.test(ua)) return 'Chrome';
                if (/Firefox\//.test(ua)) return 'Firefox';
                if (/Safari\//.test(ua) && !/Chrome/.test(ua)) return 'Safari';
                if (/Opera|OPR\//.test(ua)) return 'Opera';
                return 'Unknown';
            }

            function detectBrowserVersion(ua) {
                let match;
                if ((match = ua.match(/Edg\/(\d+\.\d+)/))) return match[1];
                if ((match = ua.match(/Chrome\/(\d+\.\d+)/))) return match[1];
                if ((match = ua.match(/Firefox\/(\d+\.\d+)/))) return match[1];
                if ((match = ua.match(/Version\/(\d+\.\d+).*Safari/))) return match[1];
                if ((match = ua.match(/OPR\/(\d+\.\d+)/))) return match[1];
                return 'Unknown';
            }

            function detectDeviceType() {
                const ua = navigator.userAgent;
                if (/iPad/.test(ua) || (navigator.maxTouchPoints > 1 && /Mac/.test(ua))) return 'tablet';
                if (/iPhone|Android.*Mobile/.test(ua)) return 'mobile';
                if (/Android/.test(ua)) return 'tablet';
                return 'desktop';
            }

            function getCurrentView() {
                // Determine current app view based on active tab or state
                const activeTab = document.querySelector('.nav-tab.active');
                if (activeTab) {
                    const tabText = activeTab.textContent.trim().toLowerCase();
                    if (tabText.includes('vote') || tabText.includes('arena')) return 'arena';
                    if (tabText.includes('rank')) return 'rankings';
                }
                return 'unknown';
            }

            function captureSystemContext() {
                const ua = navigator.userAgent;
                return {
                    timestamp: new Date().toISOString(),
                    timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                    platform: detectPlatform(ua),
                    os: detectOS(ua),
                    osVersion: detectOSVersion(ua),
                    browser: detectBrowser(ua),
                    browserVersion: detectBrowserVersion(ua),
                    deviceType: detectDeviceType(),
                    screenWidth: window.screen.width,
                    screenHeight: window.screen.height,
                    viewportWidth: window.innerWidth,
                    viewportHeight: window.innerHeight,
                    pixelRatio: window.devicePixelRatio,
                    touchEnabled: 'ontouchstart' in window,
                    isPWA: window.matchMedia('(display-mode: standalone)').matches,
                    isOnline: navigator.onLine,
                    serviceWorkerActive: 'serviceWorker' in navigator && !!navigator.serviceWorker.controller,
                    currentView: getCurrentView(),
                    theme: document.documentElement.getAttribute('data-theme') || 'light',
                    prefersReducedMotion: window.matchMedia('(prefers-reduced-motion: reduce)').matches,
                    connectionType: navigator.connection?.effectiveType || 'unknown',
                    firebaseConnected: window.firebaseAPI?.isReady() || false
                };
            }

            // ============================================
            // BUG REPORT FLOW (4-Step FSM)
            // ============================================
            const BUG_REPORT_STATE = {
                IDLE: 0,
                STEP_1_ACTION: 1,      // "What were you trying to do?"
                STEP_2_OBSERVED: 2,    // "What happened instead?"
                STEP_3_CONTEXT: 3,     // "Any other details?"
                SUBMITTING: 4
            };

            let bugReportState = BUG_REPORT_STATE.IDLE;
            let bugReportData = {};

            const BUG_PROMPTS = {
                [BUG_REPORT_STATE.STEP_1_ACTION]: "I'm sorry you ran into an issue. Can you tell me what you were trying to do when the problem occurred?",
                [BUG_REPORT_STATE.STEP_2_OBSERVED]: "Thanks for that context. What happened instead of what you expected?",
                [BUG_REPORT_STATE.STEP_3_CONTEXT]: "That's helpful. One more question: any additional details you'd like to add? (Or just type 'done' to submit)"
            };

            function startBugReportFlow() {
                bugReportState = BUG_REPORT_STATE.STEP_1_ACTION;
                bugReportData = { systemContext: captureSystemContext() };
                addMessage(BUG_PROMPTS[BUG_REPORT_STATE.STEP_1_ACTION], false);
            }

            function handleBugReportStep(input) {
                switch (bugReportState) {
                    case BUG_REPORT_STATE.STEP_1_ACTION:
                        bugReportData.action = input;
                        bugReportState = BUG_REPORT_STATE.STEP_2_OBSERVED;
                        addMessage(BUG_PROMPTS[BUG_REPORT_STATE.STEP_2_OBSERVED], false);
                        break;

                    case BUG_REPORT_STATE.STEP_2_OBSERVED:
                        bugReportData.observed = input;
                        bugReportState = BUG_REPORT_STATE.STEP_3_CONTEXT;
                        addMessage(BUG_PROMPTS[BUG_REPORT_STATE.STEP_3_CONTEXT], false);
                        break;

                    case BUG_REPORT_STATE.STEP_3_CONTEXT:
                        if (input.toLowerCase() !== 'done') {
                            bugReportData.additionalContext = input;
                        }
                        bugReportState = BUG_REPORT_STATE.SUBMITTING;
                        submitBugReport();
                        break;
                }
            }

            async function submitBugReport() {
                try {
                    // Construct message from collected bug report data
                    const bugMessage = `Bug report: Tried to ${bugReportData.action || 'use the app'}. Instead: ${bugReportData.observed || 'unexpected behavior'}${bugReportData.additionalContext ? '. Additional context: ' + bugReportData.additionalContext : ''}`;

                    const result = await callHelpbotAPI(bugMessage, {
                        type: 'bug_report',
                        ...bugReportData
                    });

                    addMessage(result.response || "Thank you for reporting this issue. Your feedback has been recorded and will be reviewed by the development team. Is there anything else about the app I can help you with?", false);
                } catch (error) {
                    console.error('[Help] Bug report submission failed:', error);
                    // Store locally for later sync
                    storePendingSubmission('bug_report', bugReportData);
                    addMessage("Thank you for your report. It's been saved and will be submitted when possible. Is there anything else I can help with?", false);
                }

                bugReportState = BUG_REPORT_STATE.IDLE;
                bugReportData = {};
            }

            // ============================================
            // FEEDBACK FLOW (Simple 1-Step)
            // ============================================
            let feedbackFlowActive = false;

            function startFeedbackFlow() {
                feedbackFlowActive = true;
                addMessage("What would you like to suggest or share? I'd love to hear your ideas for improving Christmas Stories.", false);
            }

            async function handleFeedbackStep(input) {
                feedbackFlowActive = false;

                try {
                    // Send actual user input as the message for classification
                    const result = await callHelpbotAPI(input, {
                        type: 'feedback',
                        systemContext: captureSystemContext()
                    });
                    addMessage(result.response || "Thank you for your feedback! Your suggestion has been recorded. Is there anything else about the app I can help with?", false);
                } catch (error) {
                    console.error('[Help] Feedback submission failed:', error);
                    storePendingSubmission('feedback', { message: input, systemContext: captureSystemContext() });
                    addMessage("Thanks for sharing! Your feedback has been saved. Is there anything else I can help with?", false);
                }
            }

            // ============================================
            // RATE LIMITING
            // ============================================
            const RATE_LIMIT = { maxMessages: 20, windowMs: 600000 }; // 20 per 10 min
            let messageTimestamps = [];

            function checkRateLimit() {
                const now = Date.now();
                messageTimestamps = messageTimestamps.filter(ts => now - ts < RATE_LIMIT.windowMs);

                if (messageTimestamps.length >= RATE_LIMIT.maxMessages) {
                    return false;
                }

                messageTimestamps.push(now);
                return true;
            }

            // ============================================
            // SESSION MANAGEMENT
            // ============================================
            function getOrCreateSessionId() {
                let sessionId = sessionStorage.getItem('helpbot_session_id');
                if (!sessionId) {
                    // Use crypto.getRandomValues for secure randomness
                    const randomBytes = new Uint8Array(8);
                    crypto.getRandomValues(randomBytes);
                    const randomHex = Array.from(randomBytes, b => b.toString(16).padStart(2, '0')).join('');
                    sessionId = 'sess_' + Date.now() + '_' + randomHex;
                    sessionStorage.setItem('helpbot_session_id', sessionId);
                }
                return sessionId;
            }

            // ============================================
            // API INTEGRATION
            // ============================================
            async function callHelpbotAPI(message, context) {
                const systemContext = captureSystemContext();
                const sessionId = getOrCreateSessionId();

                const response = await fetch('https://us-central1-nutcracker-3e8fb.cloudfunctions.net/helpbot', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        sessionId,
                        message,
                        systemContext,
                        context
                    })
                });

                if (!response.ok) {
                    throw new Error('API error: ' + response.status);
                }

                return await response.json();
            }

            // ============================================
            // LOCAL STORAGE FOR PENDING SUBMISSIONS
            // ============================================
            function storePendingSubmission(type, data) {
                try {
                    const pending = JSON.parse(localStorage.getItem('helpbot_pending') || '[]');
                    pending.push({
                        type,
                        data,
                        timestamp: Date.now()
                    });
                    localStorage.setItem('helpbot_pending', JSON.stringify(pending));
                } catch (e) {
                    console.error('[Help] Failed to store pending submission:', e);
                }
            }

            // ============================================
            // UI HELPERS
            // ============================================
            function openHelpDialog() {
                helpDialog.showModal();
                // Note: Don't auto-focus input - causes iOS zoom even with 16px font
                // Users will tap input when ready to type
            }

            function closeHelpDialog() {
                helpDialog.close();
            }

            function addMessage(text, isUser) {
                const msg = document.createElement('div');
                msg.className = 'help-msg ' + (isUser ? 'help-msg--user' : 'help-msg--system');
                msg.textContent = text;
                helpMessages.appendChild(msg);
                helpMessages.scrollTop = helpMessages.scrollHeight;
            }

            function addClickableOptions(options, callback) {
                const container = document.createElement('div');
                container.className = 'help-msg help-msg--system';
                container.style.display = 'flex';
                container.style.flexDirection = 'column';
                container.style.gap = '8px';

                options.forEach((option, idx) => {
                    const btn = document.createElement('button');
                    btn.type = 'button';
                    btn.textContent = option.label || option.q;
                    btn.style.cssText = 'padding: 8px 12px; border-radius: 8px; border: 1px solid var(--color-border); background: var(--color-surface); color: var(--color-text); cursor: pointer; text-align: left; transition: background 0.2s;';
                    btn.addEventListener('mouseenter', () => btn.style.background = 'var(--color-border)');
                    btn.addEventListener('mouseleave', () => btn.style.background = 'var(--color-surface)');
                    btn.addEventListener('click', () => {
                        callback(option, idx);
                        container.remove();
                    });
                    container.appendChild(btn);
                });

                helpMessages.appendChild(container);
                helpMessages.scrollTop = helpMessages.scrollHeight;
            }

            // ============================================
            // EVENT HANDLERS
            // ============================================
            helpBtn.addEventListener('click', openHelpDialog);
            helpClose.addEventListener('click', closeHelpDialog);

            helpDialog.addEventListener('click', (e) => {
                if (e.target === helpDialog) closeHelpDialog();
            });

            helpDialog.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') closeHelpDialog();
            });

            // Main form submission handler
            helpForm.addEventListener('submit', async (e) => {
                e.preventDefault();

                const input = helpInput.value.trim();
                if (!input) return;

                // Check rate limit
                if (!checkRateLimit()) {
                    addMessage("I want to make sure I can help everyone. There's a brief cooldown - your feedback has been saved. Please try again in a few minutes.", false);
                    return;
                }

                // Add user message
                addMessage(input, true);
                helpInput.value = '';

                // Check if in bug report flow
                if (bugReportState !== BUG_REPORT_STATE.IDLE) {
                    handleBugReportStep(input);
                    return;
                }

                // Check if in feedback flow
                if (feedbackFlowActive) {
                    handleFeedbackStep(input);
                    return;
                }

                // Try FAQ match first
                const matchResult = matchFaq(input);
                const route = routeByConfidence(matchResult, input);

                console.log('[Help] Match result:', { score: matchResult.score, strategy: matchResult.strategy, action: route.action });

                switch (route.action) {
                    case 'DIRECT_ANSWER':
                        addMessage(route.faq.a, false);
                        break;

                    case 'CLARIFY':
                        addMessage(route.message, false);
                        addClickableOptions(
                            [
                                { label: 'Yes, that\'s what I meant', faq: route.faq },
                                { label: 'No, that\'s not it', faq: null },
                                ...(route.alternatives || []).map(alt => ({ label: alt.faq.q, faq: alt.faq }))
                            ],
                            (option) => {
                                if (option.faq) {
                                    addMessage(option.faq.a, false);
                                } else {
                                    addMessage("Let me try to help differently. Could you rephrase your question, or would you like me to connect you with more help?", false);
                                }
                            }
                        );
                        break;

                    case 'SUGGEST':
                        addMessage(route.message, false);
                        addClickableOptions(
                            route.suggestions.map(faq => ({ label: faq.q, faq })),
                            (option) => {
                                addMessage(option.faq.a, false);
                            }
                        );
                        break;

                    case 'BUG_REPORT_FLOW':
                        startBugReportFlow();
                        break;

                    case 'FEEDBACK_FLOW':
                        startFeedbackFlow();
                        break;

                    case 'LLM_FALLBACK':
                        try {
                            // Show typing indicator
                            const typingMsg = document.createElement('div');
                            typingMsg.className = 'help-msg help-msg--system';
                            typingMsg.textContent = 'Thinking...';
                            typingMsg.id = 'help-typing';
                            helpMessages.appendChild(typingMsg);
                            helpMessages.scrollTop = helpMessages.scrollHeight;

                            const result = await callHelpbotAPI(input, route.context);

                            // Remove typing indicator
                            document.getElementById('help-typing')?.remove();

                            if (result.response) {
                                addMessage(result.response, false);
                            } else {
                                addMessage("I apologize, but I'm having trouble understanding. Could you try rephrasing your question about Christmas Stories?", false);
                            }
                        } catch (error) {
                            console.error('[Help] LLM fallback failed:', error);
                            document.getElementById('help-typing')?.remove();
                            addMessage("I'm having trouble connecting right now. Your question has been saved. In the meantime, try asking about voting, rankings, or keyboard shortcuts!", false);
                            storePendingSubmission('question', { message: input, context: route.context, systemContext: captureSystemContext() });
                        }
                        break;

                    default:
                        addMessage("I'm not sure I understand. Could you try asking about how to vote, view rankings, or use keyboard shortcuts?", false);
                }
            });

            console.log('[Help] FAQ matcher initialized');
        })();
    </script>

    <!-- Firebase Integration -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js';
        import { getAuth, signInAnonymously } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js';
        import { getFirestore, collection, addDoc, getDocs, query, orderBy, limit, serverTimestamp, deleteDoc, doc, writeBatch } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js';

        // Firebase config is intentionally public - security via Firestore rules
        const firebaseConfig = {  // pragma: allowlist secret
            apiKey: "AIzaSyAR1vsGEPDunjQxX6V0Xp2jO39xfXXgDJo",  // pragma: allowlist secret
            authDomain: "nutcracker-3e8fb.firebaseapp.com",
            projectId: "nutcracker-3e8fb",
            storageBucket: "nutcracker-3e8fb.firebasestorage.app",
            messagingSenderId: "260886503024",
            appId: "1:260886503024:web:6cd66f487ac42566059eb5",
            measurementId: "G-LZ4PX71NZ7"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Anonymous auth
        let userId = null;
        signInAnonymously(auth).then((result) => {
            userId = result.user.uid;
            // Sync localStorage visitorId with Firebase UID
            localStorage.setItem('bearRanker_visitorId', userId);
            console.log('[Firebase] Authenticated anonymously:', userId);
        }).catch((error) => {
            console.error('[Firebase] Auth failed:', error);
        });

        // Cache for global rankings (15 min TTL)
        let globalRankingsCache = null;
        let globalCacheTimestamp = 0;
        const CACHE_TTL = 15 * 60 * 1000; // 15 minutes

        // Override stub with real implementation
        window.firebaseAPI = {
            isReady: () => userId !== null,
            getVisitorId: () => userId,

            submitVote: async (winnerId, loserId) => {
                if (!userId) return false;
                try {
                    await addDoc(collection(db, 'votes'), {
                        visitorId: userId,
                        winner: winnerId,
                        loser: loserId,
                        timestamp: serverTimestamp()
                    });
                    // Invalidate cache when user votes
                    globalCacheTimestamp = 0;
                    return true;
                } catch (e) {
                    console.error('[Firebase] Vote sync failed:', e);
                    return false;
                }
            },

            submitFeedback: async (imageId, tags) => {
                if (!userId) return false;
                try {
                    await addDoc(collection(db, 'feedback'), {
                        visitorId: userId,
                        imageId,
                        tags,
                        timestamp: serverTimestamp()
                    });
                    return true;
                } catch (e) {
                    console.error('[Firebase] Feedback sync failed:', e);
                    return false;
                }
            },

            submitSuggestion: async (text) => {
                if (!userId) return false;
                try {
                    await addDoc(collection(db, 'suggestions'), {
                        visitorId: userId,
                        text: text.substring(0, 500),
                        timestamp: serverTimestamp()
                    });
                    return true;
                } catch (e) {
                    console.error('[Firebase] Suggestion sync failed:', e);
                    return false;
                }
            },

            // Fetch all votes and compute global Elo rankings
            getGlobalRankings: async (imagesList) => {
                // Return cache if valid
                if (globalRankingsCache && (Date.now() - globalCacheTimestamp) < CACHE_TTL) {
                    console.log('[Firebase] Using cached global rankings');
                    return globalRankingsCache;
                }

                // Wait for auth if not ready (max 3 seconds)
                if (!userId) {
                    console.log('[Firebase] Waiting for authentication...');
                    for (let i = 0; i < 30 && !userId; i++) {
                        await new Promise(r => setTimeout(r, 100));
                    }
                    if (!userId) {
                        console.warn('[Firebase] Auth timeout - proceeding without auth');
                    }
                }

                try {
                    console.log('[Firebase] Fetching global votes...');
                    const votesRef = collection(db, 'votes');
                    const snapshot = await getDocs(votesRef);

                    // Initialize ratings for all images
                    const ratings = {};
                    const stats = {};
                    const uniqueVoters = new Set();

                    imagesList.forEach(img => {
                        ratings[img.id] = 1500; // DEFAULT_ELO
                        stats[img.id] = { wins: 0, losses: 0 };
                    });

                    // Process all votes and compute Elo
                    const K_FACTOR = 32;
                    const votes = [];

                    snapshot.forEach(doc => {
                        const vote = doc.data();
                        votes.push(vote);
                        uniqueVoters.add(vote.visitorId);
                    });

                    // Sort by timestamp for proper Elo calculation order
                    votes.sort((a, b) => {
                        const aTime = a.timestamp?.toMillis?.() || 0;
                        const bTime = b.timestamp?.toMillis?.() || 0;
                        return aTime - bTime;
                    });

                    // Calculate Elo ratings
                    votes.forEach(vote => {
                        const { winner, loser } = vote;
                        if (!ratings[winner] || !ratings[loser]) return;

                        const expectedWinner = 1 / (1 + Math.pow(10, (ratings[loser] - ratings[winner]) / 400));
                        const expectedLoser = 1 - expectedWinner;

                        ratings[winner] += K_FACTOR * (1 - expectedWinner);
                        ratings[loser] += K_FACTOR * (0 - expectedLoser);

                        stats[winner].wins++;
                        stats[loser].losses++;
                    });

                    // Round ratings
                    Object.keys(ratings).forEach(id => {
                        ratings[id] = Math.round(ratings[id]);
                    });

                    globalRankingsCache = {
                        ratings,
                        stats,
                        totalVotes: votes.length,
                        uniqueVoters: uniqueVoters.size,
                        timestamp: Date.now()
                    };
                    globalCacheTimestamp = Date.now();

                    console.log(`[Firebase] Loaded ${votes.length} votes from ${uniqueVoters.size} voters`);
                    return globalRankingsCache;
                } catch (e) {
                    console.error('[Firebase] Failed to fetch global rankings:', e);
                    // Return error object so UI can show the message
                    return { error: true, message: e.message || 'Unknown error' };
                }
            },

            // Fetch suggestions for review
            getSuggestions: async () => {
                try {
                    const suggestionsRef = collection(db, 'suggestions');
                    const q = query(suggestionsRef, orderBy('timestamp', 'desc'), limit(100));
                    const snapshot = await getDocs(q);

                    const suggestions = [];
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        suggestions.push({
                            id: doc.id,
                            text: data.text,
                            visitorId: data.visitorId,
                            timestamp: data.timestamp?.toDate?.() || new Date()
                        });
                    });
                    return suggestions;
                } catch (e) {
                    console.error('[Firebase] Failed to fetch suggestions:', e);
                    return [];
                }
            },

            resetIdentity: () => {
                auth.signOut().then(() => {
                    localStorage.removeItem('bearRanker_visitorId');
                    location.reload();
                });
            },

            // Admin function: Clear all votes from Firebase (for testing)
            // Call from console: firebaseAPI.clearAllVotes()
            clearAllVotes: async () => {
                if (!confirm(' This will DELETE ALL VOTES from the global database. Are you sure?')) {
                    return { success: false, message: 'Cancelled by user' };
                }

                try {
                    console.log('[Firebase] Fetching all votes for deletion...');
                    const votesRef = collection(db, 'votes');
                    const snapshot = await getDocs(votesRef);

                    if (snapshot.empty) {
                        console.log('[Firebase] No votes to delete');
                        return { success: true, deleted: 0 };
                    }

                    // Delete in batches of 500 (Firestore limit)
                    const batchSize = 500;
                    let deleted = 0;
                    let batch = writeBatch(db);
                    let batchCount = 0;

                    for (const docSnap of snapshot.docs) {
                        batch.delete(doc(db, 'votes', docSnap.id));
                        batchCount++;
                        deleted++;

                        if (batchCount >= batchSize) {
                            await batch.commit();
                            console.log(`[Firebase] Deleted batch of ${batchCount} votes`);
                            batch = writeBatch(db);
                            batchCount = 0;
                        }
                    }

                    // Commit remaining
                    if (batchCount > 0) {
                        await batch.commit();
                        console.log(`[Firebase] Deleted final batch of ${batchCount} votes`);
                    }

                    // Invalidate cache
                    globalRankingsCache = null;
                    globalCacheTimestamp = 0;

                    console.log(`[Firebase] Successfully deleted ${deleted} votes`);
                    alert(` Deleted ${deleted} votes from global database`);
                    return { success: true, deleted };
                } catch (e) {
                    console.error('[Firebase] Failed to clear votes:', e);
                    alert(` Failed to clear votes: ${e.message}`);
                    return { success: false, error: e.message };
                }
            }
        };

        // ============================================
        // DEEP LINK HANDLING (for shared image URLs)
        // ============================================
        function handleDeepLink() {
            const hash = window.location.hash;
            if (hash.startsWith('#image=')) {
                const imageId = decodeURIComponent(hash.slice(7));
                const img = images.find(i => i.id === imageId);
                if (img) {
                    // Switch to rankings tab and open lightbox
                    switchTab('rankings');
                    setTimeout(() => {
                        openLightbox(img.src, img.name, img.id);
                    }, 100);
                }
            }
        }

        // Handle deep link on load
        handleDeepLink();

        // Handle hash change (browser back/forward)
        window.addEventListener('hashchange', handleDeepLink);
    </script>

    <!-- Credit block -->
    <style>
        .credit-block, .privacy-block {
            position: fixed;
            bottom: calc(8px + env(safe-area-inset-bottom, 0px));
            font-size: 10px;
            color: var(--color-text-dim);
            opacity: 0.5;
            pointer-events: auto;
            /* z-index below theme-toggle (100) but above content */
            z-index: 50;
            transition: opacity 0.2s ease;
            /* Ensure text doesn't wrap weirdly on narrow screens */
            white-space: nowrap;
        }
        .credit-block {
            right: max(12px, env(safe-area-inset-right, 0px));
        }
        .privacy-block {
            left: max(12px, env(safe-area-inset-left, 0px));
            /* Keep clear of theme toggle above */
            max-width: calc(50% - 60px);
            text-overflow: ellipsis;
            overflow: hidden;
        }
        .credit-block:hover, .privacy-block:hover {
            opacity: 0.9;
        }
        .credit-block a, .privacy-block span {
            color: inherit;
            text-decoration: none;
        }
        .credit-block a:hover {
            text-decoration: underline;
        }
        @media (max-width: 480px) {
            .credit-block, .privacy-block {
                font-size: 9px;
                /* iOS Firefox needs explicit fallback in max() */
                bottom: calc(4px + max(0px, env(safe-area-inset-bottom, 0px)));
            }
            .credit-block {
                right: max(8px, env(safe-area-inset-right, 0px));
            }
            .privacy-block {
                left: max(8px, env(safe-area-inset-left, 0px));
            }
        }
        /* Extra safety buffer for iOS Firefox safe-area handling variance */
        @supports (padding: max(0px)) {
            @media (max-width: 480px) {
                .credit-block, .privacy-block {
                    bottom: calc(4px + max(4px, env(safe-area-inset-bottom, 0px)));
                }
            }
        }
    </style>
    <div class="credit-block">
        <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener">
            Polyphony  2025 Trey Herr | CC BY-NC-SA 4.0
        </a>
    </div>
</body>
</html>
